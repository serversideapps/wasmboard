var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var RawData;
(function (RawData) {
    RawData.pieces = {
        "p": "\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg\n   xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n   xmlns:cc=\"http://creativecommons.org/ns#\"\n   xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\"\n   xmlns:svg=\"http://www.w3.org/2000/svg\"\n   xmlns=\"http://www.w3.org/2000/svg\"\n   xmlns:sodipodi=\"http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd\"\n   xmlns:inkscape=\"http://www.inkscape.org/namespaces/inkscape\"\n   viewBox=\"0 0 2048 2048\"\n   id=\"svg3044\"\n   version=\"1.1\"\n   inkscape:version=\"0.48.4 r9939\"\n   width=\"100%\"\n   height=\"100%\"\n   sodipodi:docname=\"bP.svg\">\n  <metadata\n     id=\"metadata3054\">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about=\"\">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id=\"defs3052\" />\n  <sodipodi:namedview\n     pagecolor=\"#ffffff\"\n     bordercolor=\"#666666\"\n     borderopacity=\"1\"\n     objecttolerance=\"10\"\n     gridtolerance=\"10\"\n     guidetolerance=\"10\"\n     inkscape:pageopacity=\"0\"\n     inkscape:pageshadow=\"2\"\n     inkscape:window-width=\"2880\"\n     inkscape:window-height=\"1800\"\n     id=\"namedview3050\"\n     showgrid=\"false\"\n     inkscape:zoom=\"0.75195312\"\n     inkscape:cx=\"1024\"\n     inkscape:cy=\"1024\"\n     inkscape:window-x=\"0\"\n     inkscape:window-y=\"0\"\n     inkscape:window-maximized=\"0\"\n     inkscape:current-layer=\"svg3044\" />\n  <g\n     transform=\"matrix(1 0 0 -1 0 2048)\"\n     id=\"g3046\">\n    <path\n       fill=\"#101010\"\n       d=\"M1024 205h-578v74q-4 80 41.5 137t125.5 108q117 91 171.5 217.5t78.5 267.5h-287l284 239q-86 74 -86 188q0 103 73 177t177 74q103 0 176.5 -74t73.5 -177q0 -114 -86 -188l284 -239h-287q23 -141 78 -267.5t172 -217.5q79 -51 124.5 -108t42.5 -137v-74h-578z\"\n       id=\"path3048\" />\n  </g>\n</svg>\n",
        "n": "\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg\n   xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n   xmlns:cc=\"http://creativecommons.org/ns#\"\n   xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\"\n   xmlns:svg=\"http://www.w3.org/2000/svg\"\n   xmlns=\"http://www.w3.org/2000/svg\"\n   xmlns:sodipodi=\"http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd\"\n   xmlns:inkscape=\"http://www.inkscape.org/namespaces/inkscape\"\n   viewBox=\"0 0 2048 2048\"\n   id=\"svg2\"\n   version=\"1.1\"\n   inkscape:version=\"0.48.2 r9819\"\n   width=\"100%\"\n   height=\"100%\"\n   sodipodi:docname=\"bn.svg\">\n  <metadata\n     id=\"metadata12\">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about=\"\">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\" />\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id=\"defs10\" />\n  <sodipodi:namedview\n     pagecolor=\"#ffffff\"\n     bordercolor=\"#666666\"\n     borderopacity=\"1\"\n     objecttolerance=\"10\"\n     gridtolerance=\"10\"\n     guidetolerance=\"10\"\n     inkscape:pageopacity=\"0\"\n     inkscape:pageshadow=\"2\"\n     inkscape:window-width=\"640\"\n     inkscape:window-height=\"678\"\n     id=\"namedview8\"\n     showgrid=\"false\"\n     inkscape:zoom=\"0.11523438\"\n     inkscape:cx=\"1024\"\n     inkscape:cy=\"1024\"\n     inkscape:window-x=\"0\"\n     inkscape:window-y=\"0\"\n     inkscape:window-maximized=\"0\"\n     inkscape:current-layer=\"svg2\" />\n  <g\n     transform=\"matrix(1 0 0 -1 0 2048)\"\n     id=\"g4\">\n    <path\n       fill=\"#101010\"\n       d=\"M502 1180l-52 -1l-26 -64l69 -21l46 55zM1038 1367q34 -1 -16 68t-80 42l-116 -109zM700 1465q6 39 115.5 107.5t220.5 143.5l115 154l96 -217q342 -172 432.5 -417.5t47.5 -603.5q-18 -128 4.5 -236t57.5 -190l-1242 -1q-9 178 39 301.5t183 237.5q50 11 82.5 39.5 t53.5 58.5l62.5 1t138 29t139 97t66.5 207q0 17 -8.5 34t-11.5 37q-62 -228 -161 -288.5t-191 -58.5q-236 42 -292 -60l-56 -102l-217 121l115 82l-51 50l-122 -86l-12 297zM1681 273q-102 130 -85 308.5t27 362.5t-50 351.5t-316 275.5q220 -164 252.5 -342t16.5 -350.5 t-12 -329t167 -276.5z\"\n       id=\"path6\" />\n  </g>\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 1601.3052,1693.0403 c -81.081,-89.747 -91.5841,-156.5414 -74.2276,-472.0505 20.3789,-370.45059 -8.7512,-495.11834 -150.5575,-644.33895 -28.3483,-29.83051 -47.8136,-54.23729 -43.2562,-54.23729 17.0173,0 100.1093,58.43477 144.6504,101.72598 57.0521,55.45106 86.1396,107.89196 109.6386,197.66385 34.9938,133.6852 37.5437,201.94031 17.3275,463.81811 -19.9909,258.9589 -17.5419,312.6196 18.0578,395.6705 9.6985,22.6255 16.1305,42.6404 14.2935,44.4774 -1.8371,1.8371 -18.004,-12.891 -35.9265,-32.7291 l 0,0 z\"\n     id=\"path2989\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 896.70344,621.33017 c 55.68259,-53.26842 60.42184,-55.96132 78.1017,-44.37838 26.06806,17.07847 76.40326,84.06615 70.43026,93.73076 -2.6971,4.36392 -50.55804,7.80453 -106.35772,7.6458 l -101.45395,-0.2886 59.27971,-56.70958 z\"\n     id=\"path2991\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 464.27119,941.44594 c -27.44127,-6.6005 -31.26949,-14.68402 -20.9599,-44.25815 7.68249,-22.038 14.48333,-27.65559 33.48079,-27.65559 13.112,0 30.36269,7.20749 38.33486,16.01664 13.59229,15.01931 13.36664,17.45094 -3.62386,39.05085 -9.96529,12.66881 -20.76409,22.58121 -23.99733,22.02755 -3.23325,-0.55366 -13.6888,-2.88525 -23.23456,-5.1813 z\"\n     id=\"path2993\"\n     inkscape:connector-curvature=\"0\" />\n</svg>\n",
        "b": "\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg\n   xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n   xmlns:cc=\"http://creativecommons.org/ns#\"\n   xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\"\n   xmlns:svg=\"http://www.w3.org/2000/svg\"\n   xmlns=\"http://www.w3.org/2000/svg\"\n   xmlns:sodipodi=\"http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd\"\n   xmlns:inkscape=\"http://www.inkscape.org/namespaces/inkscape\"\n   viewBox=\"0 0 2048 2048\"\n   id=\"svg2\"\n   version=\"1.1\"\n   inkscape:version=\"0.48.2 r9819\"\n   width=\"100%\"\n   height=\"100%\"\n   sodipodi:docname=\"bb.svg\">\n  <metadata\n     id=\"metadata12\">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about=\"\">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\" />\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id=\"defs10\" />\n  <sodipodi:namedview\n     pagecolor=\"#ffffff\"\n     bordercolor=\"#666666\"\n     borderopacity=\"1\"\n     objecttolerance=\"10\"\n     gridtolerance=\"10\"\n     guidetolerance=\"10\"\n     inkscape:pageopacity=\"0\"\n     inkscape:pageshadow=\"2\"\n     inkscape:window-width=\"640\"\n     inkscape:window-height=\"700\"\n     id=\"namedview8\"\n     showgrid=\"false\"\n     inkscape:zoom=\"0.11523438\"\n     inkscape:cx=\"1024\"\n     inkscape:cy=\"1024\"\n     inkscape:window-x=\"0\"\n     inkscape:window-y=\"0\"\n     inkscape:window-maximized=\"0\"\n     inkscape:current-layer=\"svg2\" />\n  <g\n     transform=\"matrix(1 0 0 -1 0 2048)\"\n     id=\"g4\">\n    <path\n       fill=\"#101010\"\n       d=\"M768 683q-5 -39 -26 -82h564q-18 36 -26 82h-512zM1263 756l46 73q-142 49 -285 47q-144 2 -285 -47l46 -73q118 40 239 38q120 2 239 -38zM831 529h-207q67 116 72 229q-114 119 -162 223.5t-6 223.5q33 96 118 189.5t312 246.5q-17 11 -46 36t-29 79q0 58 41 96t100 38 q58 0 99.5 -38t41.5 -96q0 -54 -29.5 -79t-45.5 -36q226 -153 311 -246.5t119 -189.5q42 -119 -6 -223.5t-162 -223.5q4 -113 72 -229h-207q-2 4 10 -16q33 -53 70 -60t89 -7h250q76 0 141.5 -62t65.5 -179h-495q-123 0 -223.5 84.5t-100.5 198.5q0 -114 -101 -198.5 t-223 -84.5h-495q0 117 65 179t142 62h250q51 0 88 7t71 60q12 20 10 16zM977 1230h-95v-89h95v-165h94v165h95v89h-95v104h-94v-104z\"\n       id=\"path6\" />\n  </g>\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 761.54028,1406.6983 12.85605,-39.0508 249.60367,0 249.6037,0 12.856,39.0508 12.8561,39.0509 -275.3158,0 -275.31577,0 12.85605,-39.0509 z\"\n     id=\"path2989\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 765.07813,1250.9479 -17.65316,-29.9199 44.99938,-13.0677 c 84.66507,-24.5867 172.41074,-33.5953 274.96545,-28.2302 54.8882,2.8715 113.4644,8.9793 130.1695,13.5729 16.7051,4.5936 46.7792,12.6064 66.8314,17.8062 l 36.4585,9.4541 -17.7902,30.1522 c -20.3271,34.4518 -23.3108,34.9921 -91.5848,16.5858 -68.72,-18.5267 -266.2284,-18.5267 -334.94845,0 -68.23049,18.3946 -71.26607,17.8518 -91.44762,-16.3534 z\"\n     id=\"path2991\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 980.61017,981.47797 0,-82.44068 -47.72881,0 -47.72882,0 0,-39.05085 0,-39.05085 47.72882,0 47.72881,0 0,-52.06779 0,-52.0678 43.38983,0 43.3898,0 0,52.0678 0,52.06779 47.7288,0 47.7289,0 0,39.05085 0,39.05085 -47.7289,0 -47.7288,0 0,82.44068 0,82.44063 -43.3898,0 -43.38983,0 0,-82.44063 z\"\n     id=\"path2993\"\n     inkscape:connector-curvature=\"0\" />\n</svg>\t\n",
        "r": "\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg\n   xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n   xmlns:cc=\"http://creativecommons.org/ns#\"\n   xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\"\n   xmlns:svg=\"http://www.w3.org/2000/svg\"\n   xmlns=\"http://www.w3.org/2000/svg\"\n   xmlns:sodipodi=\"http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd\"\n   xmlns:inkscape=\"http://www.inkscape.org/namespaces/inkscape\"\n   viewBox=\"0 0 2048 2048\"\n   id=\"svg2\"\n   version=\"1.1\"\n   inkscape:version=\"0.48.2 r9819\"\n   width=\"100%\"\n   height=\"100%\"\n   sodipodi:docname=\"br.svg\">\n  <metadata\n     id=\"metadata12\">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about=\"\">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\" />\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id=\"defs10\" />\n  <sodipodi:namedview\n     pagecolor=\"#ffffff\"\n     bordercolor=\"#666666\"\n     borderopacity=\"1\"\n     objecttolerance=\"10\"\n     gridtolerance=\"10\"\n     guidetolerance=\"10\"\n     inkscape:pageopacity=\"0\"\n     inkscape:pageshadow=\"2\"\n     inkscape:window-width=\"640\"\n     inkscape:window-height=\"709\"\n     id=\"namedview8\"\n     showgrid=\"false\"\n     inkscape:zoom=\"0.11523438\"\n     inkscape:cx=\"1024\"\n     inkscape:cy=\"1024\"\n     inkscape:window-x=\"0\"\n     inkscape:window-y=\"0\"\n     inkscape:window-maximized=\"0\"\n     inkscape:current-layer=\"svg2\" />\n  <g\n     transform=\"matrix(1 0 0 -1 0 2048)\"\n     id=\"g4\">\n    <path\n       fill=\"#101010\"\n       d=\"M1024 205h-641l29 264l159 118l50 659l-149 107l-17 341h289v-147h137v147h143h143v-147h137v147h289l-17 -341l-149 -107l50 -659l159 -118l29 -264h-641zM1024 1194h333l-6 88h-327h-327l-6 -88h333zM1024 547h381l-6 87h-375h-375l-6 -87h381z\"\n       id=\"path6\" />\n  </g>\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 650.84746,1457.0305 0,-39.0508 373.15254,0 373.1525,0 0,39.0508 0,39.0509 -373.1525,0 -373.15254,0 0,-39.0509 z\"\n     id=\"path2989\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 694.23729,837.64068 c 0,-8.94915 2.44068,-28.47458 5.42373,-43.38983 l 5.42373,-27.11865 318.91525,0 318.9153,0 5.4237,27.11865 c 13.0658,65.32909 43.8795,59.66101 -324.339,59.66101 -316.64934,0 -329.76271,-0.64703 -329.76271,-16.27118 z\"\n     id=\"path2991\"\n     inkscape:connector-curvature=\"0\" />\n</svg>\n",
        "q": "\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg\n   xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n   xmlns:cc=\"http://creativecommons.org/ns#\"\n   xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\"\n   xmlns:svg=\"http://www.w3.org/2000/svg\"\n   xmlns=\"http://www.w3.org/2000/svg\"\n   xmlns:sodipodi=\"http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd\"\n   xmlns:inkscape=\"http://www.inkscape.org/namespaces/inkscape\"\n   viewBox=\"0 0 2048 2048\"\n   id=\"svg2\"\n   version=\"1.1\"\n   inkscape:version=\"0.48.2 r9819\"\n   width=\"100%\"\n   height=\"100%\"\n   sodipodi:docname=\"bq.svg\">\n  <metadata\n     id=\"metadata12\">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about=\"\">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\" />\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id=\"defs10\" />\n  <sodipodi:namedview\n     pagecolor=\"#ffffff\"\n     bordercolor=\"#666666\"\n     borderopacity=\"1\"\n     objecttolerance=\"10\"\n     gridtolerance=\"10\"\n     guidetolerance=\"10\"\n     inkscape:pageopacity=\"0\"\n     inkscape:pageshadow=\"2\"\n     inkscape:window-width=\"640\"\n     inkscape:window-height=\"667\"\n     id=\"namedview8\"\n     showgrid=\"false\"\n     inkscape:zoom=\"0.11523438\"\n     inkscape:cx=\"1024\"\n     inkscape:cy=\"1024\"\n     inkscape:window-x=\"0\"\n     inkscape:window-y=\"0\"\n     inkscape:window-maximized=\"0\"\n     inkscape:current-layer=\"svg2\" />\n  <g\n     transform=\"matrix(1 0 0 -1 0 2048)\"\n     id=\"g4\">\n    <path\n       fill=\"#101010\"\n       d=\"M590 529q4 -72 -15 -158l134 86zM1024 205h-583q114 231 57.5 456.5t-202.5 449.5q-12 -2 -19 -2q-54 0 -92.5 38.5t-38.5 92.5t38.5 92.5t92.5 38.5t92.5 -38.5t38.5 -92.5q0 -20 -6 -38q-4 -14 -15 -33l196 -139l100 486q-64 31 -72 103q-5 44 29 91t88 53q54 5 96 -29 t48 -88q7 -68 -46 -114l198 -412l198 412q-54 46 -46 114q6 54 48 88t96 29q54 -6 87.5 -53t29.5 -91q-9 -72 -72 -103l100 -486l196 139q-12 19 -15 33q-6 18 -6 38q0 54 38.5 92.5t92.5 38.5t92.5 -38.5t38.5 -92.5t-38.5 -92.5t-92.5 -38.5q-7 0 -19 2 q-147 -224 -203 -449.5t58 -456.5h-583zM1024 655q109 0 222 -28.5t213 -67.5q2 41 11 89q-108 42 -221.5 68t-224.5 26t-225 -26t-221 -68q8 -48 11 -89q99 39 212 67.5t223 28.5zM1024 279h478q-15 34 -24 73h-454h-454q-10 -39 -24 -73h478zM1458 529l-119 -72l134 -86 q-20 86 -15 158zM885 482l139 -87l139 84l-139 86z\"\n       id=\"path6\" />\n  </g>\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 555.38983,1758.5831 c 0,-1.6742 4.2871,-15.342 9.52689,-30.3729 l 9.52689,-27.3288 449.55639,0 449.5564,0 9.5268,27.3288 c 5.2399,15.0309 9.527,28.6987 9.527,30.3729 0,1.6742 -210.8746,3.044 -468.6102,3.044 -257.73559,0 -468.61017,-1.3698 -468.61017,-3.044 z\"\n     id=\"path2989\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 952.36273,1602.4318 -58.62033,-37.2523 65.13723,-37.2686 65.13727,-37.2687 60.7373,36.0834 c 33.4055,19.8459 60.6625,38.8378 60.5711,42.2043 -0.2311,8.5096 -108.8863,71.2569 -122.911,70.98 -6.2872,-0.1242 -37.81039,-16.9893 -70.05157,-37.4781 l 0,0 z\"\n     id=\"path2991\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 1412.923,1632.6676 c -27.1228,-17.3706 -49.3851,-35.4879 -49.4716,-40.2608 -0.086,-4.7729 20.1524,-21.5067 44.9753,-37.1863 l 45.1326,-28.5082 5.2025,67.5591 c 2.8614,37.1575 4.8139,68.1036 4.339,68.7691 -0.475,0.6655 -23.0549,-13.0023 -50.1778,-30.3729 z\"\n     id=\"path2993\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 588.8,1452.531 c -0.71593,-16.1395 -1.6922,-33.6413 -2.16949,-38.8928 -2.09522,-23.0535 203.92127,-80.7864 343.77351,-96.3372 72.02368,-8.0087 114.68708,-8.0855 184.07668,-0.3314 140.5733,15.7087 348.9687,73.7829 346.8888,96.6686 -0.4773,5.2515 -1.4536,22.7533 -2.1695,38.8928 l -1.3017,29.3445 -101.9661,-32.592 c -133.917,-42.8047 -210.8059,-55.7092 -331.9322,-55.7092 -121.12634,0 -198.01519,12.9045 -331.9322,55.7092 L 590.10169,1481.8755 588.8,1452.531 z\"\n     id=\"path2995\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 587.65069,1602.7569 c 2.11115,-34.3298 4.52362,-65.41 5.36106,-69.0669 0.83744,-3.657 24.25108,7.5677 52.03032,24.9437 27.77924,17.3761 47.28358,34.5936 43.34299,38.2611 -3.9406,3.6676 -29.08154,20.531 -55.86876,37.4742 l -48.70404,30.8059 3.83843,-62.418 z\"\n     id=\"path2997\"\n     inkscape:connector-curvature=\"0\" />\n</svg>\n",
        "k": "\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg\n   xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n   xmlns:cc=\"http://creativecommons.org/ns#\"\n   xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\"\n   xmlns:svg=\"http://www.w3.org/2000/svg\"\n   xmlns=\"http://www.w3.org/2000/svg\"\n   xmlns:sodipodi=\"http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd\"\n   xmlns:inkscape=\"http://www.inkscape.org/namespaces/inkscape\"\n   viewBox=\"0 0 2048 2048\"\n   id=\"svg2\"\n   version=\"1.1\"\n   inkscape:version=\"0.48.2 r9819\"\n   width=\"100%\"\n   height=\"100%\"\n   sodipodi:docname=\"bk.svg\">\n  <metadata\n     id=\"metadata12\">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about=\"\">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource=\"http://purl.org/dc/dcmitype/StillImage\" />\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id=\"defs10\" />\n  <sodipodi:namedview\n     pagecolor=\"#ffffff\"\n     bordercolor=\"#666666\"\n     borderopacity=\"1\"\n     objecttolerance=\"10\"\n     gridtolerance=\"10\"\n     guidetolerance=\"10\"\n     inkscape:pageopacity=\"0\"\n     inkscape:pageshadow=\"2\"\n     inkscape:window-width=\"640\"\n     inkscape:window-height=\"673\"\n     id=\"namedview8\"\n     showgrid=\"false\"\n     inkscape:zoom=\"0.11523438\"\n     inkscape:cx=\"1024\"\n     inkscape:cy=\"1024\"\n     inkscape:window-x=\"0\"\n     inkscape:window-y=\"0\"\n     inkscape:window-maximized=\"0\"\n     inkscape:current-layer=\"svg2\" />\n  <g\n     transform=\"matrix(1 0 0 -1 0 2048)\"\n     id=\"g4\">\n    <path\n       fill=\"#101010\"\n       d=\"M1024 279h489l-12 73h-477h-477l-12 -73h489zM1024 1200q-25 60 -62 111q31 48 62 65q30 -17 62 -65q-38 -51 -62 -111zM927 746q-154 -11 -303 -58q-123 108 -200 213.5t-77 201.5q0 89 73.5 159t148.5 70q67 0 134.5 -62.5t102.5 -130.5q30 -54 75 -175t46 -218z M577 529l-26 -156l145 84zM1024 1436q-47 0 -136 -121q-31 36 -50 55q93 140 186 140q92 0 186 -140q-20 -19 -50 -55q-90 121 -136 121zM1024 661q-1 126 -42 267.5t-84 226.5q-8 14 -14 27t-12 23q-28 43 -48 69q-51 63 -120 105t-134 42q-103 0 -208 -93t-105 -229 q0 -120 99 -254.5t249 -259.5q201 74 419 76zM1024 205h-576l61 365q-325 280 -326 535q-1 159 125 274.5t267 115.5q78 0 158.5 -47t142.5 -119q61 -74 98.5 -164.5t49.5 -150.5q12 60 49 150.5t99 164.5q61 72 142 119t159 47q140 0 266 -115.5t126 -274.5 q-2 -255 -326 -535l61 -365h-576zM1121 746q0 97 45 218t76 175q34 68 101.5 130.5t135.5 62.5q74 0 147.5 -70t74.5 -159q0 -96 -77 -201.5t-200 -213.5q-150 47 -303 58zM1471 529l-119 -72l145 -84zM1024 661q217 -2 419 -76q150 125 249 259.5t99 254.5 q0 136 -105.5 229t-207.5 93q-66 0 -135 -42t-119 -105q-21 -26 -48 -69q-6 -10 -12.5 -23l-13.5 -27q-44 -85 -85 -226.5t-41 -267.5zM885 502l139 -86l139 84l-139 86zM977 1750v95h94v-95h107v-95h-107v-153q-48 16 -94 0v153h-107v95h107z\"\n       id=\"path6\" />\n  </g>\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 1401.4915,1445.0218 c -78.8657,-27.9719 -280.8492,-63.4896 -361.055,-63.4896 -13.5729,0 -8.3701,-92.9378 9.9317,-177.4108 46.5412,-214.81404 134.473,-397.65875 231.4791,-481.3361 104.2876,-89.95837 202.4256,-110.29259 301.8815,-62.54996 101.7059,48.82269 168.8559,126.47534 192.6106,222.736 11.9521,48.43347 12.5067,65.83472 3.6329,113.99457 -20.0474,108.80099 -81.3793,205.35889 -221.2364,348.30369 -109.9971,112.4256 -114.1265,115.0451 -157.2444,99.7522 z m 122.8177,-179.6594 c 134.7609,-141.4644 175.4829,-214.4621 176.1913,-315.83774 0.4683,-67.03663 -13.4333,-101.83522 -61.5242,-154.00777 -143.4095,-155.58091 -315.1045,-83.45215 -434.3981,182.48989 -42.6209,95.01492 -76.4874,206.09722 -82.5156,270.65102 -5.7063,61.108 -10.2312,57.4923 84.8046,67.7654 26.5972,2.875 83.221,14.3756 125.8305,25.5568 42.6095,11.1812 81.9736,20.7494 87.4759,21.2628 5.5022,0.5134 52.3632,-43.5328 104.1356,-97.8804 l 0,0 z\"\n     id=\"path2989\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"M 522.69348,1378.7619 C 282.85431,1147.8294 214.58388,976.10591 297.00399,811.07562 307.70836,789.64221 338.00727,752.40497 364.33493,728.3262 467.72145,633.77083 573.50641,610.75174 673.3258,661.08895 778.26588,714.00843 850.6748,798.31641 911.25199,938.11388 969.78,1073.1823 1015.322,1248.2704 1015.322,1338.215 l 0,41.9358 -58.57624,5.339 c -104.0056,9.4797 -214.78092,29.5868 -283.86381,51.5246 l -67.44533,21.4179 -82.74314,-79.6704 z m 186.38255,-35.874 c 46.72683,-11.7086 106.43583,-23.6599 132.68668,-26.5583 95.0231,-10.4919 89.91439,-6.2064 83.92014,-70.3974 -6.61695,-70.8594 -56.45658,-218.8281 -106.45317,-316.0484 -88.352,-171.80383 -210.06736,-249.01461 -320.08376,-203.04682 -44.15978,18.45113 -116.43706,87.49453 -135.7522,129.67827 -19.05108,41.60706 -20.9871,132.18468 -3.85178,180.20755 22.6552,63.4927 71.07585,130.9368 164.1489,228.6396 51.77234,54.3476 95.54808,98.8139 97.27942,98.8139 1.73135,0 41.37895,-9.5798 88.10577,-21.2884 z\"\n     id=\"path2991\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"M 1003.3744,949.74058 C 986.85194,899.18356 931.32063,785.54395 906.05991,750.5957 c -13.35176,-18.4722 -11.90128,-21.12111 41.57869,-75.93221 38.00403,-38.94995 61.9944,-56.7923 76.3614,-56.7923 14.367,0 38.3574,17.84235 76.3614,56.7923 53.717,55.05403 54.9805,57.37814 41.2802,75.93221 -24.0218,32.53209 -99.7443,191.12876 -105.4708,220.90261 -2.9834,15.51186 -7.9186,28.17512 -10.9671,28.14057 -3.0485,-0.0347 -12.8717,-22.48878 -21.8293,-49.8983 l 0,0 z m 56.6668,-157.68022 31.7022,-59.81846 -28.5336,-31.15146 c -15.6935,-17.1333 -33.3379,-31.15146 -39.2098,-31.15146 -5.8719,0 -23.5163,14.01816 -39.20978,31.15146 l -28.53362,31.15146 31.70221,59.81846 c 17.43619,32.90016 33.65479,59.81847 36.04119,59.81847 2.3864,0 18.605,-26.91831 36.0412,-59.81847 z\"\n     id=\"path2993\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 961.08475,1587.5558 c -32.21695,-20.136 -58.54284,-38.6067 -58.50197,-41.046 0.0409,-2.4394 27.06664,-21.0865 60.05728,-41.4381 l 59.98294,-37.003 61.4343,36.958 c 33.7888,20.3268 61.4342,39.4619 61.4342,42.5224 0,4.9152 -115.8443,77.2345 -123.0087,76.7918 -1.552,-0.096 -29.18111,-16.6492 -61.39805,-36.7851 z\"\n     id=\"path2995\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 558.77664,1652.3188 c 2.3664,-8.1326 6.96336,-34.312 10.21546,-58.1764 8.99418,-66.0007 11.04011,-67.1917 62.32993,-36.2864 25.05763,15.0988 45.55933,29.9113 45.55933,32.9166 0,3.0053 -27.54164,21.4096 -61.20364,40.8985 -45.11665,26.1206 -60.07274,31.5477 -56.90108,20.6477 z\"\n     id=\"path2997\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 1431.8644,1631.7223 c -31.0237,-18.3043 -57.3928,-36.2297 -58.5979,-39.8342 -2.4479,-7.3215 86.9459,-63.409 92.3885,-57.9665 3.4172,3.4172 26.4635,128.9748 23.9283,130.3629 -0.7217,0.3952 -26.6952,-14.2578 -57.7189,-32.5622 z\"\n     id=\"path2999\"\n     inkscape:connector-curvature=\"0\" />\n  <path\n     style=\"fill:#ececec;fill-opacity:1;stroke:#101010;stroke-width:0;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:3.79999995;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0\"\n     d=\"m 545.06485,1732.9898 3.54586,-30.3729 475.38929,0 475.3893,0 3.5458,30.3729 3.5459,30.3729 -482.481,0 -482.48102,0 3.54587,-30.3729 z\"\n     id=\"path3001\"\n     inkscape:connector-curvature=\"0\" />\n</svg>\n"
    };
})(RawData || (RawData = {}));
var GlobalUtils;
(function (GlobalUtils) {
    var Vect = /** @class */ (function () {
        function Vect(_x, _y) {
            this.x = _x;
            this.y = _y;
        }
        Vect.prototype.calctrig = function (r, multrby) {
            if (multrby === void 0) { multrby = Math.PI; }
            this.sin = Math.sin(r * multrby);
            this.cos = Math.cos(r * multrby);
        };
        Vect.prototype.r = function (r) {
            this.calctrig(r);
            return new Vect(this.x * this.cos - this.y * this.sin, this.x * this.sin + this.y * this.cos);
        };
        Vect.prototype.n = function (l) {
            var c = (l / this.l());
            return new Vect(this.x * c, this.y * c);
        };
        Vect.prototype.u = function () { return this.n(1); };
        Vect.prototype.p = function (v) {
            return new Vect(this.x + v.x, this.y + v.y);
        };
        Vect.prototype.m = function (v) {
            return new Vect(this.x - v.x, this.y - v.y);
        };
        Vect.prototype.i = function () {
            return new Vect(-this.x, -this.y);
        };
        Vect.prototype.s = function (s) {
            return new Vect(this.x * s, this.y * s);
        };
        Vect.prototype.l = function () {
            return Math.sqrt(this.x * this.x + this.y * this.y);
        };
        return Vect;
    }());
    GlobalUtils.Vect = Vect;
    var INFINITE_COORD = 1E6;
    var Polygon = /** @class */ (function () {
        function Polygon() {
            this.vects = [];
        }
        Polygon.prototype.a = function (v) {
            this.vects.push(v);
            return this;
        };
        Polygon.prototype.normalize = function (overwrite) {
            var _this = this;
            if (overwrite === void 0) { overwrite = true; }
            var minx = INFINITE_COORD;
            var miny = INFINITE_COORD;
            var maxx = -INFINITE_COORD;
            var maxy = -INFINITE_COORD;
            this.vects.map(function (v) {
                if (v.x < minx)
                    minx = v.x;
                if (v.y < miny)
                    miny = v.y;
                if (v.x > maxx)
                    maxx = v.x;
                if (v.y > maxy)
                    maxy = v.y;
            });
            var min = new Vect(minx, miny);
            var max = new Vect(maxx, maxy);
            this.shift = min.i();
            this.size = max.m(min);
            if (overwrite) {
                this.vects = this.vects.map(function (v) {
                    return v.p(_this.shift);
                });
            }
            return this;
        };
        // should only be called on a normalized polygon
        Polygon.prototype.reportSvg = function (bcol) {
            if (bcol === void 0) { bcol = "#dfdf3f"; }
            var points = this.vects.map(function (v) { return (v.x + "," + v.y); }).join(" ");
            return "\n<svg width=\"" + this.size.x + "\" height=\"" + this.size.y + "\" style=\"position:absolute;top:0px;left:0px;\">\n<polygon points=\"" + points + "\" style=\"fill:" + bcol + ";stroke-width:0px;\">\n</svg>\n";
        };
        return Polygon;
    }());
    GlobalUtils.Polygon = Polygon;
    var Arrow = /** @class */ (function () {
        function Arrow(from, to, params) {
            var widthfactor = params["widthfactor"] || 0.1;
            var handlelength = params["handlelength"] || 0.7;
            var headfactor = params["headfactor"] || 0.2;
            var constantwidth = params["constantwidth"] || 0.0;
            var cw = (constantwidth != 0.0);
            var diff = to.m(from);
            var width = cw ? constantwidth : diff.l() * widthfactor;
            var bottomright = cw ? diff.n(constantwidth / 2.0).r(0.5) : diff.n(width / 2.0).r(0.5);
            var bottomleft = bottomright.i();
            var handle = cw ? diff.n(diff.l() - 3.0 * constantwidth) : diff.n(diff.l() * handlelength);
            var headfromright = bottomright.p(handle);
            var headfromleft = bottomleft.p(handle);
            var headtoright = headfromright.p(cw ? bottomright.s(2.0) : bottomright.n(diff.l() * headfactor));
            var headtoleft = headfromleft.p(cw ? bottomleft.s(2.0) : bottomleft.n(diff.l() * headfactor));
            var pg = new Polygon().
                a(bottomright).
                a(headfromright).
                a(headtoright).
                a(diff).
                a(headtoleft).
                a(headfromleft).
                a(bottomleft).
                normalize();
            this.svgorig = to.m(pg.vects[3]);
            this.svg = pg.reportSvg(params["color"]);
        }
        return Arrow;
    }());
    GlobalUtils.Arrow = Arrow;
    var Timer = /** @class */ (function () {
        function Timer(_activityname, _log) {
            this.start = performance.now();
            this.activityname = _activityname;
            this.log = _log;
            _log(_activityname + " started");
        }
        Timer.prototype.report = function () {
            var finish = performance.now();
            var elapsed = finish - this.start;
            this.log(this.activityname + " took " + elapsed.toLocaleString());
        };
        return Timer;
    }());
    GlobalUtils.Timer = Timer;
    var TwoWayMap = /** @class */ (function () {
        function TwoWayMap(_kvs) {
            this.kvs = _kvs;
        }
        TwoWayMap.prototype.g = function (elem) {
            if (this.kvs[elem] != undefined)
                return this.kvs[elem];
            for (var k in this.kvs) {
                var v = this.kvs[k];
                if (v == elem)
                    return k;
            }
            return null;
        };
        return TwoWayMap;
    }());
    GlobalUtils.TwoWayMap = TwoWayMap;
    var Logger = /** @class */ (function () {
        function Logger() {
            this.LOG_MAX = 100;
            this.logitems = [];
        }
        Logger.prototype.log = function (item) {
            this.logitems.push(item);
            if (this.logitems.length > this.LOG_MAX) {
                this.logitems = this.logitems.slice(1);
            }
        };
        return Logger;
    }());
    GlobalUtils.Logger = Logger;
    var TEnc = /** @class */ (function () {
        function TEnc(label, options) {
            this.tenc = new TextEncoder(label, options);
        }
        TEnc.prototype.encode = function (input, options) {
            return this.tenc.encode(input, options);
        };
        return TEnc;
    }());
    GlobalUtils.TEnc = TEnc;
    var TDec = /** @class */ (function () {
        function TDec(label, options) {
            this.tdec = new TextDecoder(label, options);
        }
        TDec.prototype.decode = function (input, options) {
            return this.tdec.decode(input, options);
        };
        return TDec;
    }());
    GlobalUtils.TDec = TDec;
    var tdec = new GlobalUtils.TDec();
    var tenc = new GlobalUtils.TEnc();
    ///////////////////////////////////////////////////////
    // from: https://stackoverflow.com/questions/33702838/how-to-append-bytes-multi-bytes-and-buffer-to-arraybuffer-in-javascript
    function concatTypedArrays(a, b) {
        var c = new (a.constructor)(a.length + b.length);
        c.set(a, 0);
        c.set(b, a.length);
        return c;
    }
    ///////////////////////////////////////////////////////
    var MemView = /** @class */ (function () {
        function MemView(_view) {
            this.view = _view;
        }
        MemView.prototype.toString = function () {
            var term = this.view.indexOf(0);
            if (term < 0)
                return null; // not a C terminated string
            return tdec.decode(this.view.slice(0, term));
        };
        MemView.prototype.strCpy = function (str) {
            var view = tenc.encode(str);
            var viewt = concatTypedArrays(view, new Uint8Array([0]));
            this.view.set(viewt);
        };
        return MemView;
    }());
    GlobalUtils.MemView = MemView;
    var WasmLoader = /** @class */ (function () {
        function WasmLoader(_url, params) {
            this.importObject = {
                env: {
                    memoryBase: 0,
                    tableBase: 0,
                    memory: new WebAssembly.Memory({ initial: 256 }),
                    table: new WebAssembly.Table({ initial: 0, element: 'anyfunc' })
                }
            };
            this.url = _url;
            for (var key in params) {
                var value = params[key];
                this.importObject.env[key] = value;
            }
        }
        WasmLoader.prototype.env = function () { return this.importObject.env; };
        WasmLoader.prototype.memory = function () { return this.env().memory; };
        WasmLoader.prototype.membuff = function () { return this.memory().buffer; };
        WasmLoader.prototype.memview = function (from, size) {
            return new MemView(new Uint8Array(this.membuff(), from, size));
        };
        WasmLoader.prototype.fetchThen = function (callback) {
            var _this = this;
            if (callback === void 0) { callback = null; }
            fetch(this.url).then(function (response) { return response.arrayBuffer(); }).then(function (bytes) { return WebAssembly.instantiate(bytes, _this.importObject); }).then(function (results) {
                _this.module = results.instance;
                _this.exports = _this.module.exports;
                if (callback != null)
                    callback();
            });
        };
        return WasmLoader;
    }());
    GlobalUtils.WasmLoader = WasmLoader;
})(GlobalUtils || (GlobalUtils = {}));
var Piece = /** @class */ (function () {
    function Piece(_kind, _color) {
        if (_kind === void 0) { _kind = "-"; }
        if (_color === void 0) { _color = 0; }
        this.kind = _kind;
        this.color = _color;
    }
    Piece.prototype.algeb = function () {
        return this.kind + this.color;
    };
    Piece.prototype.empty = function () {
        return this.kind == "-";
    };
    Piece.prototype.equalto = function (p) {
        return ((this.kind == p.kind) && (this.color == p.color));
    };
    return Piece;
}());
var Square = /** @class */ (function () {
    function Square(_file, _rank) {
        this.file = _file;
        this.rank = _rank;
    }
    Square.prototype.Plus = function (sq) {
        return new Square(this.file + sq.file, this.rank + sq.rank);
    };
    Square.prototype.Minus = function (sq) {
        return new Square(this.file - sq.file, this.rank - sq.rank);
    };
    Square.prototype.Normalize = function () {
        if (this.file == 0)
            return new Square(0, this.rank > 0 ? 1 : -1);
        if (this.rank == 0)
            return new Square(this.file > 0 ? 1 : -1, 0);
        return null;
    };
    Square.prototype.Rotate = function (rot) {
        switch (rot) {
            case 1: return new Square(this.rank, -this.file);
            case -1: return new Square(-this.rank, this.file);
        }
    };
    Square.prototype.isRoughlyEqualTo = function (sq) {
        if (sq.file == null) {
            if (sq.rank == null)
                return true;
            else
                return this.rank == sq.rank;
        }
        else {
            if (sq.rank == null)
                return this.file == sq.file;
            else
                return this.isEqualTo(sq);
        }
    };
    Square.prototype.isEqualTo = function (sq) {
        return ((this.file == sq.file) && (this.rank == sq.rank));
    };
    return Square;
}());
var TreeNode = /** @class */ (function () {
    function TreeNode() {
        this.moves = {};
    }
    return TreeNode;
}());
var GameNode = /** @class */ (function () {
    function GameNode() {
        this.childs = {};
        this.genalgeb = "";
        this.gensan = "";
        this.fen = "";
        this.parent = null;
        this.fullmove_number = 1;
        this.turn = 1;
    }
    GameNode.prototype.has = function (algeb) {
        var c = this.childs[algeb];
        return ((c != undefined) && (c != null));
    };
    GameNode.prototype.algebs = function () {
        return Object.keys(this.childs);
    };
    GameNode.prototype.haschild = function () {
        return (this.algebs().length > 0);
    };
    GameNode.prototype.mainchild = function () {
        var mainalgeb = this.algebs()[0];
        return this.childs[mainalgeb];
    };
    GameNode.prototype.reportTreeNode = function (current) {
        var tn = new TreeNode();
        for (var gni in this.childs) {
            var gn = this.childs[gni];
            tn.moves[gn.gensan] = gn.reportTreeNode(current);
            if (gn == current)
                tn.moves[gn.gensan].current = true;
        }
        return tn;
    };
    return GameNode;
}());
var Pgn = /** @class */ (function () {
    function Pgn() {
    }
    return Pgn;
}());
var Move = /** @class */ (function () {
    function Move(_fromsq, _tosq, _prom) {
        if (_prom === void 0) { _prom = new Piece(); }
        this.promotion = false;
        this.capture = false;
        this.pawnmove = false;
        this.pawnpushby = 0;
        this.castling = false;
        this.epcapture = false;
        this.fromsq = _fromsq;
        this.tosq = _tosq;
        this.prom = _prom;
        if (!_prom.empty())
            this.promotion = true;
    }
    Move.prototype.Capture = function () {
        this.capture = true;
        return this;
    };
    Move.prototype.PawnPush = function (by) {
        this.pawnpushby = by;
        this.pawnmove = true;
        return this;
    };
    Move.prototype.PawnCapture = function () {
        this.capture = true;
        this.pawnmove = true;
        return this;
    };
    Move.prototype.Castling = function () {
        this.castling = true;
        return this;
    };
    Move.prototype.EpSquare = function (_epsq) {
        this.epsq = _epsq;
        return this;
    };
    Move.prototype.EpClearSquare = function (_epclsq) {
        this.epclsq = _epclsq;
        this.epcapture = true;
        return this.PawnCapture();
    };
    Move.prototype.isRoughlyEqualTo = function (m) {
        var fe = (m.fromsq != null) ? this.fromsq.isEqualTo(m.fromsq) : true;
        var te = (m.tosq != null) ? this.tosq.isEqualTo(m.tosq) : true;
        return (fe && te);
    };
    Move.prototype.isEqualTo = function (m) {
        return ((this.isRoughlyEqualTo(m)) && (this.prom.kind == m.prom.kind));
    };
    Move.prototype.info = function () {
        var info = "";
        if (this.capture)
            info += "x";
        if (this.castling)
            info += "c";
        if (this.promotion)
            info += "=" + this.prom.kind;
        if (this.pawnmove)
            info += "p";
        if (this.pawnpushby > 0)
            info += this.pawnpushby;
        if (this.epsq != undefined)
            info += "(e" + this.epsq.sq.file + "," + this.epsq.sq.rank + ")";
        if (this.epcapture)
            info += "epx" + this.epclsq.file + "," + this.epclsq.rank;
        return info;
    };
    return Move;
}());
var EpSquare = /** @class */ (function () {
    function EpSquare(_sq, _clsq, _cnt, _color) {
        this.sq = _sq;
        this.clsq = _clsq;
        this.cnt = _cnt;
        this.color = _color;
    }
    EpSquare.prototype.isEqualToSq = function (_sq) {
        return this.sq.isEqualTo(_sq);
    };
    EpSquare.prototype.canDecrease = function () {
        this.cnt--;
        return (this.cnt >= 0);
    };
    return EpSquare;
}());
var GeneralBoardState = /** @class */ (function () {
    function GeneralBoardState() {
    }
    return GeneralBoardState;
}());
var BoardState = /** @class */ (function (_super) {
    __extends(BoardState, _super);
    function BoardState() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    BoardState.prototype.update = function (rbs) {
        this.turn = rbs.turn;
        this.castlingRights = rbs.castlingRights;
        this.epSquares = rbs.epSquares;
        this.fullmove_number = rbs.fullmove_number;
        this.halfmove_clock = rbs.halfmove_clock;
    };
    BoardState.prototype.getEpSquare = function (ei) {
        var esq = this.epSquares[ei];
        return new EpSquare(new Square(esq.sq.file, esq.sq.rank), new Square(esq.clsq.file, esq.clsq.rank), esq.cnt, esq.color);
    };
    BoardState.prototype.setEpSquare = function (ei, epsq) {
        this.epSquares[ei] = epsq;
    };
    BoardState.prototype.pushEpSquare = function (epsq) {
        this.epSquares.push(epsq);
    };
    BoardState.prototype.getNumEpSquares = function () {
        if (this.epSquares == undefined)
            return 0;
        return this.epSquares.length;
    };
    BoardState.prototype.setEpSquares = function (epsqs) {
        this.epSquares = epsqs;
    };
    return BoardState;
}(GeneralBoardState));
var ReportableBoardState = /** @class */ (function (_super) {
    __extends(ReportableBoardState, _super);
    function ReportableBoardState(_rawfen, boardstate) {
        var _this = _super.call(this) || this;
        _this.rawfen = _rawfen;
        _this.turn = boardstate.turn;
        _this.castlingRights = boardstate.castlingRights;
        _this.epSquares = boardstate.epSquares;
        _this.fullmove_number = boardstate.fullmove_number;
        _this.halfmove_clock = boardstate.halfmove_clock;
        return _this;
    }
    return ReportableBoardState;
}(GeneralBoardState));
var CastlingRegistry = /** @class */ (function () {
    function CastlingRegistry(_kingSquare, _rookSquare, _emptySquares, _passingSquares) {
        this.kingSquare = _kingSquare;
        this.rookSquare = _rookSquare;
        this.emptySquares = _emptySquares;
        this.passingSquares = _passingSquares;
    }
    return CastlingRegistry;
}());
var Config;
(function (Config) {
    //////////////////////////////////////////////////////////////////////
    Config.scalefactor = 1.0;
    //////////////////////////////////////////////////////////////////////
    Config.SUPPORTED_VARIANTS = [
        "standard",
        "atomic",
        "fourplayer"
    ];
    //////////////////////////////////////////////////////////////////////
    // configuration constants
    var STANDARD_NUM_PLAYERS = 2;
    var FOUR_PLAYER_NUM_PLAYERS = 4;
    var STANDARD_NUM_FILES = 8;
    var FOUR_PLAYER_NUM_FILES = 14;
    var STANDARD_NUM_RANKS = 8;
    var FOUR_PLAYER_NUM_RANKS = 14;
    var STANDARD_TURN_ADVANCER = { 1: 0, 0: 1 };
    var FOUR_PLAYER_TURN_ADVANCER = { 1: 2, 2: 0, 0: 3, 3: 1 };
    var STANDARD_PROMOTION_PIECES = ["n", "b", "r", "q"];
    var STANDARD_NON_PAWN_PIECES = ["n", "b", "r", "q", "k"];
    var STANDARD_ALL_PIECES = ["p", "n", "b", "r", "q", "k"];
    var STANDARD_PAWN_DIRECTIONS_BY_COLOR = [
        new Square(0, 1),
        new Square(0, -1)
    ];
    var FOUR_PLAYER_PAWN_DIRECTIONS_BY_COLOR = [
        new Square(0, 1),
        new Square(0, -1),
        new Square(-1, 0),
        new Square(1, 0)
    ];
    ///*
    var STANDARD_START_RAW_FEN = "r0n0b0q0k0b0n0r0" +
        "p0p0p0p0p0p0p0p0" +
        "-0-0-0-0-0-0-0-0" +
        "-0-0-0-0-0-0-0-0" +
        "-0-0-0-0-0-0-0-0" +
        "-0-0-0-0-0-0-0-0" +
        "p1p1p1p1p1p1p1p1" +
        "r1n1b1q1k1b1n1r1";
    //*/
    // promotion test
    /*
    let STANDARD_START_RAW_FEN =
            "r0-0-0q0k0b0n0r0"+
            "p0p1p0p0p0p0p0p0"+
            "-0-0-0-0-0-0-0-0"+
            "-0-0-0-0-0-0-0-0"+
            "-0-0-0-0-0-0-0-0"+
            "-0-0-0-0-0-0-0-0"+
            "p1p1p1p1p1p1p1p1"+
            "r1n1b1q1k1b1n1r1"
    */
    // castling test
    /*
    let STANDARD_START_RAW_FEN =
            "r0-0-0-0k0-0-0r0"+
            "-0-0-0-0-0-0-0-0"+
            "-0-0-0-0-0-0-0-0"+
            "-0-0-0-0-0-0-0-0"+
            "-0-0-0-0-0-0-0-0"+
            "-0-0-0-0-0-0-0-0"+
            "-0-0-0-0-0-0-0-0"+
            "r1-0-0-0k1-0-0r1"
    */
    var FOUR_PLAYER_START_RAW_FEN = "-0-0-0r0n0b0q0k0b0n0r0-0-0-0" +
        "-0-0-0p0p0p0p0p0p0p0p0-0-0-0" +
        "-0-0-0-0-0-0-0-0-0-0-0-0-0-0" +
        "r3p3-0-0-0-0-0-0-0-0-0-0p2r2" +
        "n3p3-0-0-0-0-0-0-0-0-0-0p2n2" +
        "b3p3-0-0-0-0-0-0-0-0-0-0p2b2" +
        "k3p3-0-0-0-0-0-0-0-0-0-0p2q2" +
        "q3p3-0-0-0-0-0-0-0-0-0-0p2k2" +
        "b3p3-0-0-0-0-0-0-0-0-0-0p2b2" +
        "n3p3-0-0-0-0-0-0-0-0-0-0p2n2" +
        "r3p3-0-0-0-0-0-0-0-0-0-0p2r2" +
        "-0-0-0-0-0-0-0-0-0-0-0-0-0-0" +
        "-0-0-0p1p1p1p1p1p1p1p1-0-0-0" +
        "-0-0-0r1n1b1k1q1b1n1r1-0-0-0";
    //////////////////////////////////////////////////////////////////////
    Config.STANDARD_CASTLE_SAN_MAPPINGS = [
        new GlobalUtils.TwoWayMap({
            "O-O": "Kh8",
            "O-O-O": "Ka8"
        }),
        new GlobalUtils.TwoWayMap({
            "O-O": "Kh1",
            "O-O-O": "Ka1"
        })
    ];
    //////////////////////////////////////////////////////////////////////
    // configurations object
    var ChessConfiguration = /** @class */ (function () {
        function ChessConfiguration(_variantId, _variantDisplayName, _variantCode, parameters) {
            this.canCastle = true;
            this.standardReportable = false;
            this.nonPawnPieces = STANDARD_NON_PAWN_PIECES;
            this.allPieces = STANDARD_ALL_PIECES;
            this.variantId = _variantId;
            this.variantDisplayName = _variantDisplayName;
            this.variantCode = _variantCode;
            for (var parameterId in parameters) {
                var value = parameters[parameterId];
                switch (parameterId) {
                    case "numPlayers":
                        this.numPlayers = value;
                        break;
                    case "numFiles":
                        this.numFiles = value;
                        break;
                    case "numRanks":
                        this.numRanks = value;
                        break;
                    case "turnAdvancer":
                        this.turnAdvancer = value;
                        break;
                    case "promotionPieces":
                        this.promotionPieces = value;
                        break;
                    case "canCastle":
                        this.canCastle = value;
                        break;
                    case "standardReportable":
                        this.standardReportable = value;
                        break;
                    case "nonPawnPieces":
                        this.nonPawnPieces = value;
                        break;
                    case "allPieces":
                        this.allPieces = value;
                        break;
                    case "pawnDirectionsByColor":
                        this.pawnDirectionsByColor = value;
                        break;
                    case "startRawFen":
                        this.startRawFen = value;
                        break;
                }
            }
            if (this.numPlayers == undefined)
                this.numPlayers = STANDARD_NUM_PLAYERS;
            if (this.numFiles == undefined) {
                if (this.numPlayers == STANDARD_NUM_PLAYERS)
                    this.numFiles = STANDARD_NUM_FILES;
                else if (this.numPlayers == FOUR_PLAYER_NUM_PLAYERS)
                    this.numFiles = FOUR_PLAYER_NUM_FILES;
            }
            if (this.numRanks == undefined) {
                if (this.numPlayers == STANDARD_NUM_PLAYERS)
                    this.numRanks = STANDARD_NUM_RANKS;
                else if (this.numPlayers == FOUR_PLAYER_NUM_PLAYERS)
                    this.numRanks = FOUR_PLAYER_NUM_RANKS;
            }
            if (this.turnAdvancer == undefined) {
                if (this.numPlayers == STANDARD_NUM_PLAYERS)
                    this.turnAdvancer = STANDARD_TURN_ADVANCER;
                else if (this.numPlayers == FOUR_PLAYER_NUM_PLAYERS)
                    this.turnAdvancer = FOUR_PLAYER_TURN_ADVANCER;
            }
            if (this.promotionPieces == undefined) {
                this.promotionPieces = STANDARD_PROMOTION_PIECES;
            }
            if (!this.standardReportable) {
                if (this.numPlayers == 2)
                    this.standardReportable = true;
            }
            if (this.pawnDirectionsByColor == undefined) {
                if (this.numPlayers == STANDARD_NUM_PLAYERS)
                    this.pawnDirectionsByColor = STANDARD_PAWN_DIRECTIONS_BY_COLOR;
                else if (this.numPlayers == FOUR_PLAYER_NUM_PLAYERS)
                    this.pawnDirectionsByColor = FOUR_PLAYER_PAWN_DIRECTIONS_BY_COLOR;
            }
            if (this.startRawFen == undefined) {
                if (this.numPlayers == STANDARD_NUM_PLAYERS)
                    this.startRawFen = STANDARD_START_RAW_FEN;
                else if (this.numPlayers == FOUR_PLAYER_NUM_PLAYERS)
                    this.startRawFen = FOUR_PLAYER_START_RAW_FEN;
            }
            this.lastPlayer = this.numPlayers - 1;
            this.lastFile = this.numFiles - 1;
            this.lastRank = this.numRanks - 1;
            this.area = this.numFiles * this.numRanks;
            this.nonPawnPiecesCapital = this.nonPawnPieces.map(function (x) { return x.toUpperCase(); });
        }
        return ChessConfiguration;
    }());
    Config.ChessConfiguration = ChessConfiguration;
    //////////////////////////////////////////////////////////////////////
    // configurations
    var STANDARD_CHESS_CONFIGURATION = new ChessConfiguration("standard", "Standard", 201, {});
    var ATOMIC_CHESS_CONFIGURATION = new ChessConfiguration("atomic", "Atomic", 202, {});
    var FOUR_PLAYER_CHESS_CONFIGURATION = new ChessConfiguration("fourplayer", "Four Player", 401, {
        "numPlayers": FOUR_PLAYER_NUM_PLAYERS
    });
    //////////////////////////////////////////////////////////////////////
    // configuration manager
    var ChessConfigurationManager = /** @class */ (function () {
        function ChessConfigurationManager(configurationList) {
            this.configurations = {};
            for (var i in configurationList) {
                var configuration = configurationList[i];
                this.configurations[configuration.variantId] = configuration;
            }
        }
        ChessConfigurationManager.prototype.getConfigurationByVariantId = function (variantId) {
            return this.configurations[variantId];
        };
        return ChessConfigurationManager;
    }());
    //////////////////////////////////////////////////////////////////////
    Config.chessConfigurationManager = new ChessConfigurationManager([
        STANDARD_CHESS_CONFIGURATION,
        ATOMIC_CHESS_CONFIGURATION,
        FOUR_PLAYER_CHESS_CONFIGURATION
    ]);
    //////////////////////////////////////////////////////////////////////
    var MOVE_VECTORS_BY_PIECE_KIND = {
        "n": [
            new Square(1, 2),
            new Square(1, -2),
            new Square(-1, 2),
            new Square(-1, -2),
            new Square(2, 1),
            new Square(2, -1),
            new Square(-2, 1),
            new Square(-2, -1)
        ],
        "b": [
            new Square(1, 1),
            new Square(1, -1),
            new Square(-1, 1),
            new Square(-1, -1)
        ],
        "r": [
            new Square(1, 0),
            new Square(-1, 0),
            new Square(0, 1),
            new Square(0, -1)
        ],
        "q": [
            new Square(1, 0),
            new Square(-1, 0),
            new Square(0, 1),
            new Square(0, -1),
            new Square(1, 1),
            new Square(1, -1),
            new Square(-1, 1),
            new Square(-1, -1)
        ]
    };
    function getMovevectorsByPieceKind(kind) {
        // use queen vectors for king
        var k = (kind != "k" ? kind : "q");
        return MOVE_VECTORS_BY_PIECE_KIND[k];
    }
    Config.getMovevectorsByPieceKind = getMovevectorsByPieceKind;
    //////////////////////////////////////////////////////////////////////
    function Scaled(coord) { return coord * Config.scalefactor; }
    Config.Scaled = Scaled;
    function UnScaled(coord) { return coord / Config.scalefactor; }
    Config.UnScaled = UnScaled;
    //////////////////////////////////////////////////////////////////////
})(Config || (Config = {}));
var Utils;
(function (Utils) {
    var ScreenVector = /** @class */ (function () {
        function ScreenVector(_x, _y) {
            this.x = _x;
            this.y = _y;
        }
        ScreenVector.prototype.Scaled = function () {
            return new ScreenVector(Config.Scaled(this.x), Config.Scaled(this.y));
        };
        ScreenVector.prototype.UnScaled = function () {
            return new ScreenVector(Config.UnScaled(this.x), Config.UnScaled(this.y));
        };
        ScreenVector.prototype.Plus = function (sv) {
            return new ScreenVector(this.x + sv.x, this.y + sv.y);
        };
        ScreenVector.prototype.Minus = function (sv) {
            return new ScreenVector(this.x - sv.x, this.y - sv.y);
        };
        return ScreenVector;
    }());
    Utils.ScreenVector = ScreenVector;
    Utils.FILE_LETTER = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n"];
    Utils.DECIMAL_LETTER = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
    Utils.RANK_LETTER = Utils.DECIMAL_LETTER;
    Utils.FILE_LETTER_TO_FILE = { "a": 0, "b": 1, "c": 2, "d": 3, "e": 4, "f": 5, "g": 6, "h": 7, "i": 8, "j": 9, "k": 10, "l": 11, "m": 12, "n": 13 };
    Utils.FILE_TO_FILE_LETTER = { 0: "a", 1: "b", 2: "c", 3: "d", 4: "e", 5: "f", 6: "g", 7: "h", 8: "i", 9: "j", 10: "k", 11: "l", 12: "m", 13: "n" };
    function idpart(id, index) {
        var parts = id.split("_");
        return parts[index];
    }
    Utils.idpart = idpart;
    var Tokenizer = /** @class */ (function () {
        function Tokenizer(_content) {
            this.content = _content;
            this.tokens = _content.split("");
        }
        Tokenizer.prototype.pull = function (accept, maxnum) {
            if (maxnum === void 0) { maxnum = 100; }
            var buffer = "";
            while ((this.tokens.length > 0) && (maxnum > 0)) {
                var c = this.tokens[0];
                if (accept != null) {
                    if (accept.indexOf(c) < 0)
                        return buffer;
                    buffer += this.tokens.shift();
                }
                else {
                    if (c == " ")
                        return buffer;
                    buffer += this.tokens.shift();
                }
                maxnum--;
            }
            return buffer;
        };
        Tokenizer.prototype.pullUntil = function (stopat) {
            var buffer = "";
            while (this.tokens.length > 0) {
                var c = this.tokens[0];
                if (c == stopat)
                    return buffer;
                buffer += this.tokens.shift();
            }
            return buffer;
        };
        Tokenizer.prototype.pullSquare = function (b) {
            var fstr = this.pull(Utils.FILE_LETTER, 1);
            if (fstr != "") {
                var rstr = this.pull(Utils.RANK_LETTER);
                if (rstr != "") {
                    var algeb = fstr + rstr;
                    return b.algebToSquare(algeb);
                }
                else {
                    var f = BoardUtils.fileLetterToFile(fstr);
                    return new Square(f, null);
                }
            }
            else {
                var rstr = this.pull(Utils.RANK_LETTER);
                if (rstr != "") {
                    var r = BoardUtils.rankLetterToRank(b, rstr);
                    return new Square(null, r);
                }
                else {
                    return null;
                }
            }
        };
        Tokenizer.prototype.pullSan = function () {
            this.pull([" "]);
            this.pull(Utils.DECIMAL_LETTER);
            this.pull([".", " "]);
            return this.pull(null);
        };
        return Tokenizer;
    }());
    Utils.Tokenizer = Tokenizer;
    var ThinkingOutput = /** @class */ (function () {
        function ThinkingOutput(_prot, _variant) {
            if (_prot === void 0) { _prot = "uci"; }
            if (_variant === void 0) { _variant = "standard"; }
            this.bestmove = "";
            this.scorecp = true;
            this.scoremate = false;
            this.score = 0;
            this.depth = 0;
            this.prot = _prot;
            this.variant = _variant;
        }
        ThinkingOutput.prototype.parseuci = function (buffer) {
            var parts = buffer.split(new RegExp("^info "));
            if (parts.length < 2) {
                //console.log("uci string without info "+buffer)
                return;
            }
            var infoparts = parts[1].split(" ");
            var parsekey = true;
            var key;
            var pvitems = [];
            for (var i in infoparts) {
                if (parsekey) {
                    key = infoparts[i];
                    parsekey = false;
                }
                else {
                    var value = infoparts[i];
                    if (key == "score") {
                        if (value == "cp") {
                            this.scorecp = true;
                        }
                        else if (value == "mate") {
                            this.scoremate = true;
                        }
                        else {
                            this.score = parseInt(value);
                            parsekey = true;
                        }
                    }
                    else if (key == "depth") {
                        this.depth = parseInt(value);
                        parsekey = true;
                    }
                    else if (key == "pv") {
                        pvitems.push(value);
                    }
                    else {
                        parsekey = true;
                    }
                }
            }
            if (pvitems.length > 0) {
                this.bestmove = pvitems[0];
            }
        };
        ThinkingOutput.prototype.parse = function (buffer) {
            var buffercleaned = buffer.replace(new RegExp("\\r", "g"), "");
            if (this.prot == "uci") {
                this.parseuci(buffercleaned);
            }
        };
        return ThinkingOutput;
    }());
    Utils.ThinkingOutput = ThinkingOutput;
})(Utils || (Utils = {}));
var Document_ = /** @class */ (function () {
    function Document_() {
    }
    Document_.prototype.getStyleOfId = function (id) {
        return document.getElementById(id).style.cssText;
    };
    Document_.prototype.setStyleOfId = function (id, css) {
        document.getElementById(id).setAttribute("style", css);
    };
    Document_.prototype.getNode_ById = function (id) {
        var e = document.getElementById(id);
        var n;
        switch (e.tagName) {
            case "DIV":
                n = new Div_();
                n.n = e;
                return n;
            case "BUTTON":
                n = new Button_();
                n.n = e;
                return n;
            case "SELECT":
                n = new Select_();
                n.n = e;
                return n;
            case "OPTION":
                n = new Option_();
                n.n = e;
                return n;
            case "TEXTAREA":
                n = new Textarea_();
                n.n = e;
                return n;
            case "TABLE":
                n = new Table_();
                n.n = e;
                return n;
            case "TR":
                n = new Tr_();
                n.n = e;
                return n;
            case "TD":
                n = new Td_();
                n.n = e;
                return n;
            case "A":
                n = new A_();
                n.n = e;
                return n;
            case "BR":
                n = new A_();
                n.n = e;
                return n;
            default: return null;
        }
    };
    return Document_;
}());
var Node_Globals;
(function (Node_Globals) {
    Node_Globals.doc = new Document_();
})(Node_Globals || (Node_Globals = {}));
//////////////////////////////////////////////////////////
var Node_ = /** @class */ (function () {
    function Node_(_id, _kind) {
        if (_id === void 0) { _id = ""; }
        // style
        this.properties = {};
        this.id = _id;
        this.kind = _kind;
        this.n = document.createElement(_kind);
        this.setId(_id);
    }
    Node_.prototype.setId = function (_id) {
        this.n.setAttribute("id", _id);
        return this;
    };
    Node_.prototype.reportstyle = function () {
        var props = new Array();
        for (var key in this.properties) {
            props.push(key + ":" + this.properties[key]);
        }
        return props.join(";");
    };
    Node_.prototype.decomposestyle = function (css) {
        this.properties = {};
        var parts = css.split(";");
        for (var i in parts) {
            var partnospace = parts[i].replace(new RegExp(" ", "g"), "");
            var subparts = partnospace.split(":");
            if (subparts.length == 2) {
                var property = subparts[0];
                var value = subparts[1];
                this.properties[property] = value;
            }
        }
        return this;
    };
    Node_.prototype.getpx = function (property) {
        return parseFloat(this.properties[property].replace("px", ""));
    };
    Node_.prototype.s = function (property, value) { this.properties[property] = value; return this; };
    Node_.prototype.spx = function (property, value) { this.properties[property] = value + "px"; return this; };
    Node_.prototype.sspx = function (property, value) { this.properties[property] = Config.Scaled(value) + "px"; return this; };
    Node_.prototype.swpx = function (value) { this.properties["width"] = value + "px"; return this; };
    Node_.prototype.swspx = function (value) { this.properties["width"] = Config.Scaled(value) + "px"; return this; };
    Node_.prototype.shpx = function (value) { this.properties["height"] = value + "px"; return this; };
    Node_.prototype.shspx = function (value) { this.properties["height"] = Config.Scaled(value) + "px"; return this; };
    Node_.prototype.stpx = function (top) { this.properties["top"] = top + "px"; return this; };
    Node_.prototype.stspx = function (top) { this.properties["top"] = Config.Scaled(top) + "px"; return this; };
    Node_.prototype.slpx = function (left) { this.properties["left"] = left + "px"; return this; };
    Node_.prototype.slspx = function (left) { this.properties["left"] = Config.Scaled(left) + "px"; return this; };
    Node_.prototype.scol = function (col) { this.properties["color"] = col; return this; };
    Node_.prototype.sbcol = function (bcol) { this.properties["background-color"] = bcol; return this; };
    Node_.prototype.szi = function (z_index) { this.properties["z-index"] = "" + z_index; return this; };
    Node_.prototype.spos = function (position) { this.properties["position"] = position; return this; };
    Node_.prototype.spadpx = function (padding) { this.properties["padding"] = padding + "px"; return this; };
    Node_.prototype.spadspx = function (padding) { this.properties["padding"] = Config.Scaled(padding) + "px"; return this; };
    Node_.prototype.sop = function (opacity) { this.properties["opacity"] = "" + opacity; return this; };
    Node_.prototype.sburl = function (url) { this.properties["background"] = "url(" + url + ")"; return this; };
    Node_.prototype.sovf = function (ovf) { this.properties["overflow"] = ovf; return this; };
    Node_.prototype.sff = function (ff) { this.properties["font-family"] = ff; return this; };
    Node_.prototype.sfspx = function (fs) { this.properties["font-size"] = fs + "px"; return this; };
    Node_.prototype.sfsspx = function (fs) { this.properties["font-size"] = Config.Scaled(fs) + "px"; return this; };
    Node_.prototype.sv = function (v) { this.properties["visibility"] = v ? "visible" : "hidden"; return this; };
    Node_.prototype.scur = function (cur) { this.properties["cursor"] = cur; return this; };
    Node_.prototype.finalize = function () {
        this.n.setAttribute("style", this.reportstyle());
        return this;
    };
    Node_.prototype.html = function (html) {
        this.n.innerHTML = html;
        this.finalize();
        return this;
    };
    Node_.prototype.innerHTML = function (html) {
        this.n.innerHTML = html;
        return this;
    };
    Node_.prototype.attr = function (name, value) {
        this.n.setAttribute(name, value);
        return this;
    };
    Node_.prototype.appendChild = function (n_) {
        this.n.appendChild(n_.n);
        return this;
    };
    Node_.prototype.a = function (n_) {
        this.n.appendChild(n_.n);
        return this;
    };
    Node_.prototype.addel = function (kind, handler) {
        this.n.addEventListener(kind, handler);
        return this;
    };
    return Node_;
}());
var Div_ = /** @class */ (function (_super) {
    __extends(Div_, _super);
    function Div_(id) {
        if (id === void 0) { id = ""; }
        return _super.call(this, id, "div") || this;
    }
    return Div_;
}(Node_));
var Button_ = /** @class */ (function (_super) {
    __extends(Button_, _super);
    function Button_(caption, handler) {
        if (caption === void 0) { caption = ""; }
        if (handler === void 0) { handler = null; }
        var _this = _super.call(this, "", "input") || this;
        _this.n.setAttribute("type", "button");
        _this.n.setAttribute("value", caption);
        _this.addel("mousedown", handler);
        return _this;
    }
    return Button_;
}(Node_));
var Option_ = /** @class */ (function (_super) {
    __extends(Option_, _super);
    function Option_(key, caption, selected) {
        if (key === void 0) { key = ""; }
        if (caption === void 0) { caption = ""; }
        if (selected === void 0) { selected = false; }
        var _this = _super.call(this, "", "option") || this;
        _this.n.setAttribute("id", key);
        _this.n.setAttribute("name", key);
        _this.n.setAttribute("value", key);
        _this.n.innerHTML = caption;
        if (selected) {
            _this.n.setAttribute("selected", "true");
        }
        return _this;
    }
    return Option_;
}(Node_));
var Select_ = /** @class */ (function (_super) {
    __extends(Select_, _super);
    function Select_(handler) {
        if (handler === void 0) { handler = null; }
        var _this = _super.call(this, "", "select") || this;
        _this.addel("change", handler);
        return _this;
    }
    return Select_;
}(Node_));
var Textarea_ = /** @class */ (function (_super) {
    __extends(Textarea_, _super);
    function Textarea_(rows, cols) {
        if (rows === void 0) { rows = 3; }
        if (cols === void 0) { cols = 40; }
        var _this = _super.call(this, "", "textarea") || this;
        _this.n.setAttribute("rows", "" + rows);
        _this.n.setAttribute("cols", "" + cols);
        return _this;
    }
    Textarea_.prototype.setText = function (content) {
        this.n.innerHTML = content;
        return this;
    };
    return Textarea_;
}(Node_));
var Table_ = /** @class */ (function (_super) {
    __extends(Table_, _super);
    function Table_(cellpadding, cellspacing, border) {
        if (cellpadding === void 0) { cellpadding = 3; }
        if (cellspacing === void 0) { cellspacing = 3; }
        if (border === void 0) { border = 0; }
        return _super.call(this, "", "table") || this;
    }
    return Table_;
}(Node_));
var Tr_ = /** @class */ (function (_super) {
    __extends(Tr_, _super);
    function Tr_() {
        return _super.call(this, "", "tr") || this;
    }
    return Tr_;
}(Node_));
var Td_ = /** @class */ (function (_super) {
    __extends(Td_, _super);
    function Td_(colspan) {
        if (colspan === void 0) { colspan = 1; }
        var _this = _super.call(this, "", "td") || this;
        _this.attr("colspan", "" + colspan);
        return _this;
    }
    return Td_;
}(Node_));
var A_ = /** @class */ (function (_super) {
    __extends(A_, _super);
    function A_(href, caption, handler) {
        if (href === void 0) { href = ""; }
        if (caption === void 0) { caption = ""; }
        if (handler === void 0) { handler = null; }
        var _this = _super.call(this, "", "a") || this;
        _this.attr("href", href);
        _this.innerHTML(caption);
        if (handler != null) {
            _this.addel("mousedown", handler);
        }
        return _this;
    }
    return A_;
}(Node_));
var Br_ = /** @class */ (function (_super) {
    __extends(Br_, _super);
    function Br_() {
        return _super.call(this, "", "br") || this;
    }
    return Br_;
}(Node_));
var Tab = /** @class */ (function () {
    function Tab(_id, _caption) {
        this.id = _id;
        this.caption = _caption;
    }
    return Tab;
}());
var TabPane_ = /** @class */ (function (_super) {
    __extends(TabPane_, _super);
    function TabPane_(id, width, height, _tabs, _selid) {
        if (_selid === void 0) { _selid = null; }
        var _this = _super.call(this, id, "div") || this;
        _this.MARGIN = 24;
        _this.UNSELECTED_TAB_BCOL = "#dfdfdf";
        _this.TABDIV_BCOL = "#afffff";
        _this.SELECTED_TAB_BCOL = _this.TABDIV_BCOL;
        _this.selid = null;
        _this.selid = _selid;
        _this.tabs = _tabs;
        _this.tabtds = [];
        _this.tabdivs = [];
        _this.
            swpx(width).
            shpx(height).
            sovf("hidden").
            finalize();
        _this.table = new Table_();
        _this.tr1 = new Tr_();
        _this.tr2 = new Tr_();
        var ctd = new Td_().
            spos("relative").
            finalize();
        for (var tabi in _tabs) {
            var tab = _tabs[tabi];
            var ttd = new Td_().
                setId(_this.tabtdId(tab.id)).
                sbcol(_this.UNSELECTED_TAB_BCOL).
                scur("pointer").
                html(tab.caption);
            ttd.addel("mousedown", _this.tabhandler.bind(_this, _this.tabtdId(tab.id), tab.id));
            _this.tabtds.push(ttd);
            _this.tr1.a(ttd);
            var div = new Div_(_this.contentId(tab.id)).
                swpx(width - _this.MARGIN).
                shpx(height - _this.MARGIN).
                spos("absolute").
                stpx(0).
                slpx(0).
                sbcol(_this.TABDIV_BCOL).
                sovf("scroll").
                sv(false).
                finalize();
            ctd.a(div);
            _this.tabdivs.push(div);
            _this.tr2.a(ctd);
        }
        _this.table.a(_this.tr1);
        _this.table.a(_this.tr2);
        _this.a(_this.table);
        _this.setSelected(_this.selid);
        return _this;
    }
    TabPane_.prototype.setSelected = function (tabid) {
        if (tabid === void 0) { tabid = null; }
        if (tabid == null) {
            var storedselid = localStorage.getItem(this.id);
            if (storedselid != undefined)
                this.selid = storedselid;
            else
                this.selid = this.tabs[0].id;
        }
        else
            this.selid = tabid;
        for (var tabdivi in this.tabdivs) {
            var tabdiv = this.tabdivs[tabdivi];
            var tab = this.tabs[tabdivi];
            var tabtd = this.tabtds[tabdivi];
            var v = (tab.id == this.selid);
            tabdiv.sv(v).finalize();
            tabtd.sbcol(v ? this.SELECTED_TAB_BCOL : this.UNSELECTED_TAB_BCOL).finalize();
        }
        localStorage.setItem(this.id, this.selid);
    };
    TabPane_.prototype.tabhandler = function (tabtdid, tabid, e) {
        this.setSelected(tabid);
    };
    TabPane_.prototype.tabtdId = function (tabid) { return tabid + "_tabtd"; };
    TabPane_.prototype.contentId = function (tabid) { return tabid + "_content"; };
    TabPane_.prototype.getTabIndexById = function (tabid) {
        for (var ti in this.tabs) {
            var tab = this.tabs[ti];
            if (tab.id == tabid)
                return parseInt(ti);
        }
        return 0;
    };
    TabPane_.prototype.setContent = function (tabid, content) {
        var ti = this.getTabIndexById(tabid);
        var tabdiv = this.tabdivs[ti];
        tabdiv.innerHTML(content);
    };
    TabPane_.prototype.setNode_ = function (tabid, node_) {
        var ti = this.getTabIndexById(tabid);
        var tabdiv = this.tabdivs[ti];
        tabdiv.a(node_);
    };
    return TabPane_;
}(Node_));
var Text_ = /** @class */ (function (_super) {
    __extends(Text_, _super);
    function Text_() {
        var _this = _super.call(this, "", "input") || this;
        _this.n.setAttribute("type", "text");
        return _this;
    }
    Text_.prototype.getText = function () {
        var v = this.n.value;
        return v;
    };
    return Text_;
}(Node_));
var wBoard = /** @class */ (function (_super) {
    __extends(wBoard, _super);
    function wBoard(_callback) {
        if (_callback === void 0) { _callback = null; }
        var _this = _super.call(this, "assets/wasm/board/board.wasm", {
            "setTempRet0": function (x) { },
            "getTempRet0": function (x) { },
            "_i64Add": function (x) { }
        }) || this;
        ///////////////////////////////////////////////
        // buffer name mappings
        _this.INBUF = 0;
        _this.OUTBUF = 1;
        _this.OUTBUF2 = 2;
        _this.TEMPBUF = 3;
        _this.TEMPBUF2 = 4;
        _this.OUTBUF3 = 5;
        _this.importObject.env["_conslog"] = function () { return console.log(_this.out(_this.OUTBUF3)); };
        _this.callback = _callback;
        _this.fetchThen(_this.onload.bind(_this));
        return _this;
    }
    wBoard.prototype.onload = function () {
        this.buffers = [];
        for (var i = 0; i < this.exports._getNumStrBuffers(); i++) {
            this.buffers.push(this.memview(this.exports._addr(i), this.exports._getStrBufferLength()));
        }
        this.inbuf = this.buffers[this.INBUF];
        if (this.callback != null) {
            this.callback();
        }
    };
    wBoard.prototype["in"] = function (str) {
        this.inbuf.strCpy(str);
        return this;
    };
    wBoard.prototype.out = function (i) {
        if (i === void 0) { i = this.OUTBUF; }
        return this.buffers[i].toString();
    };
    wBoard.prototype.toCase = function (_case) {
        this.exports._toCase(_case);
    };
    wBoard.prototype.newBoard = function (variant, i) {
        if (i === void 0) { i = 0; }
        this.exports._newBoard(variant, i);
    };
    wBoard.prototype.reportBoardText = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._reportBoardText(i);
        return this.out();
    };
    wBoard.prototype.setFromRawFen = function (fen, i) {
        if (i === void 0) { i = 0; }
        this["in"](fen).exports._setFromRawFen(i);
    };
    wBoard.prototype.kindToNumber = function (kind) {
        switch (kind) {
            case 'n': return 110;
            case 'b': return 98;
            case 'r': return 114;
            case 'q': return 113;
            case 'k': return 107;
            default: return 45;
        }
    };
    wBoard.prototype.makeMove = function (m, i) {
        if (i === void 0) { i = 0; }
        this.exports._makeMove(i, m.fromsq.file, m.fromsq.rank, m.tosq.file, m.tosq.rank, this.kindToNumber(m.prom.kind), m.prom.color + 48);
    };
    wBoard.prototype.setTurn = function (color, i) {
        if (i === void 0) { i = 0; }
        this.exports._setTurn(i, color + 48);
    };
    wBoard.prototype.setFullmoveNumber = function (fn, i) {
        if (i === void 0) { i = 0; }
        this.exports._setFullmoveNumber(i, fn);
    };
    wBoard.prototype.setHalfmoveClock = function (hc, i) {
        if (i === void 0) { i = 0; }
        this.exports._setHalfmoveClock(i, hc);
    };
    wBoard.prototype.resetEpSquares = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._resetEpSquaresI(i);
    };
    wBoard.prototype.setEpSquare = function (color, epf, epr, epclf, epclr, cnt, i) {
        if (i === void 0) { i = 0; }
        this.exports._setEpSquare(i, color + 48, epf, epr, epclf, epclr, cnt + 1);
    };
    wBoard.prototype.resetCastlingRegistries = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._resetCastlingRegistriesI(i);
    };
    wBoard.prototype.setCastlingRegistry = function (ci, cs, right, kf, kr, rf, rr, i) {
        if (i === void 0) { i = 0; }
        this.exports._setCastlingRegistry(i, ci, cs, right, kf, kr, rf, rr);
    };
    wBoard.prototype.setCastlingRegistryEmpty = function (ci, cs, si, f, r, i) {
        if (i === void 0) { i = 0; }
        this.exports._setCastlingRegistryEmpty(i, ci, cs, si, f, r);
    };
    wBoard.prototype.setCastlingRegistryPassing = function (ci, cs, si, f, r, i) {
        if (i === void 0) { i = 0; }
        this.exports._setCastlingRegistryPassing(i, ci, cs, si, f, r);
    };
    wBoard.prototype.sortedLegalSanList = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._sortedLegalSanListI(i);
        return this.out();
    };
    wBoard.prototype.deleteGameInfo = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._deleteGameInfoI(i);
    };
    wBoard.prototype.back = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._backI(i);
    };
    wBoard.prototype.forward = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._forwardI(i);
    };
    wBoard.prototype["delete"] = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._deleteI(i);
    };
    wBoard.prototype.tobegin = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._tobeginI(i);
    };
    wBoard.prototype.toend = function (i) {
        if (i === void 0) { i = 0; }
        this.exports._toendI(i);
    };
    return wBoard;
}(GlobalUtils.WasmLoader));
var BoardDraw;
(function (BoardDraw) {
    function node_() {
        this.pids = [];
        var boardcontainer = new Div_("boardcontainer").
            swspx(this.totalwidth()).
            shspx(this.totalheight()).
            sburl("assets/images/backgrounds/wood.jpg").
            szi(Board.CONTAINER_Z_INDEX).
            spos("relative").
            finalize();
        var rootnode = new Div_("board").
            swspx(this.width()).
            shspx(this.height()).
            stspx(this.BOARD_MARGIN).
            slspx(this.BOARD_MARGIN).
            sburl("assets/images/backgrounds/wood.jpg").
            spos("absolute").
            szi(Board.BACKGROUND_Z_INDEX).
            finalize();
        for (var nf = 0; nf < this.cfg.numFiles; nf++) {
            for (var nr = 0; nr < this.cfg.numRanks; nr++) {
                var sq = new Square(nf, nr);
                var algeb = this.squareToAlgeb(sq);
                var rsq = this.rotateSquare(sq, this.flip);
                var f = rsq.file;
                var r = rsq.rank;
                var sqdiv = new Div_().
                    stspx(r * this.SQUARE_SIZE).
                    slspx(f * this.SQUARE_SIZE).
                    swspx(this.SQUARE_SIZE).
                    shspx(this.SQUARE_SIZE).
                    sbcol((((nr + nf) % 2) == 0) ? Board.LIGHT_SQUARE_COLOR : Board.DARK_SQUARE_COLOR).
                    spos("absolute").
                    sop(Board.SQUARE_OPACITY).
                    szi(Board.SQUARE_Z_INDEX).
                    finalize();
                if (this.isSquareValid(sq)) {
                    rootnode.appendChild(sqdiv);
                }
                var p = this.getPieceAtSquare(new Square(nf, nr));
                if (!p.empty()) {
                    var svg = RawData.pieces[p.kind];
                    var fillcol = Board.PIECE_FILL_COLORS[p.color];
                    var strokecol = Board.PIECE_STROKE_COLORS[p.color];
                    svg = svg.replace("fill=\"#101010\"", "fill=\"" + fillcol + "\"");
                    svg = svg.replace("fill:#ececec", "fill:" + strokecol);
                    svg = svg.replace("stroke:#101010", "stroke:" + fillcol);
                    var pid = "piece_" + algeb;
                    var pdiv = new Div_(pid).
                        stspx(r * this.SQUARE_SIZE + this.SQUARE_PADDING).
                        slspx(f * this.SQUARE_SIZE + this.SQUARE_PADDING).
                        swspx(this.PIECE_SIZE).
                        shspx(this.PIECE_SIZE).
                        spos("absolute").
                        sop(Board.PIECE_OPACITIES[p.color]).
                        attr("draggable", "true").
                        szi(Board.PIECE_Z_INDEX).
                        html(svg).
                        addel("dragstart", piecedragstart.bind(this, pid));
                    rootnode.appendChild(pdiv);
                    this.pids.push(pid);
                }
            }
        }
        rootnode.addel("mousemove", boardmousemove.bind(this));
        rootnode.addel("mouseup", boardmouseup.bind(this));
        this.rootnode = rootnode;
        if (this.current.parent != null) {
            this.drawMoveArrowAlgeb(this.current.genalgeb);
        }
        var eadiv = new Div_();
        this.enginearrow = eadiv;
        var depthdiv = new Div_();
        this.depthdiv = depthdiv;
        var scorediv = new Div_();
        this.scorediv = scorediv;
        rootnode.a(eadiv);
        rootnode.a(depthdiv);
        rootnode.a(scorediv);
        boardcontainer.a(rootnode);
        return boardcontainer;
    }
    BoardDraw.node_ = node_;
    function variantDisplayName(k) {
        return Config.chessConfigurationManager.getConfigurationByVariantId(k).variantDisplayName;
    }
    BoardDraw.variantDisplayName = variantDisplayName;
    function draw() {
        var _this = this;
        if (this.anchorid != "") {
            var anchordiv = doc.getNode_ById(this.anchorid);
            anchordiv.innerHTML("");
            var table = new Table_();
            var tr1 = new Tr_();
            var tr2 = new Tr_();
            table.a(tr1);
            table.a(tr2);
            var boardtd = new Td_();
            boardtd.a(this.node_());
            var controlsdiv = new Div_();
            var variantcombo = new Select_(varianthandler.bind(this));
            for (var i in Config.SUPPORTED_VARIANTS) {
                var k = Config.SUPPORTED_VARIANTS[i];
                var v = variantDisplayName(k);
                var s = (k == this.variant);
                variantcombo.a(new Option_(k, v, s));
            }
            controlsdiv.a(variantcombo);
            controlsdiv.a(new Button_("F", fliphandler.bind(this)));
            controlsdiv.a(new Button_("<<", tobeginhandler.bind(this)));
            controlsdiv.a(new Button_("<", backhandler.bind(this)));
            controlsdiv.a(new Button_(">", forwardhandler.bind(this)));
            controlsdiv.a(new Button_(">>", toEndhandler.bind(this)));
            controlsdiv.a(new Button_("D", delhandler.bind(this)));
            controlsdiv.a(new Button_("R", resethandler.bind(this)));
            controlsdiv.a(new Button_("Rnd", randomhandler.bind(this)));
            controlsdiv.a(new Button_(">", analyzehandler.bind(this)));
            controlsdiv.a(new Button_("_", stopanalysishandler.bind(this)));
            controlsdiv.a(new Button_("*", makeanalyzedmovehandler.bind(this)));
            controlsdiv.a(new Button_("!", starthandler.bind(this)));
            boardtd.a(controlsdiv);
            tr1.a(boardtd);
            var movestd = new Td_().
                swspx(this.width() / 3.0).
                spos("relative").
                finalize();
            var movesdiv_1 = new Div_().sovf("scroll").
                shspx(this.totalheight()).
                swspx(this.width() / 3.0).
                stpx(0).
                slpx(0).
                sff("monospace").
                spos("absolute").
                finalize();
            /*let lt=new GlobalUtils.Timer("jslegal",this.log.bind(this))
            for(let i=0;i<100;i++){
                this.legalMoves()
            }
            lt.report()
    
            lt=new GlobalUtils.Timer("wasmlegal",this.log.bind(this))
            for(let i=0;i<100;i++){
                this.wb.sortedLegalSanList()
            }
            lt.report()*/
            /*let moveinfos:[string,Move][]=this.legalMoves().map(x=>[this.moveToSan(x),x])
            moveinfos.sort((a:[string,Move],b:[string,Move])=>{
                if((a[0][0].toLocaleUpperCase()==a[0][0])&&(b[0][0].toLocaleUpperCase()!=b[0][0])) return -1
                if((b[0][0].toLocaleUpperCase()==b[0][0])&&(a[0][0].toLocaleUpperCase()!=a[0][0])) return 1
                return a[0].localeCompare(b[0],"en")
            })
            
            moveinfos.map(mi=>{
                movesdiv.a(new A_("#",mi[0],legalmoveclicked.bind(this,mi[1])))
                movesdiv.a(new Br_())
            })*/
            var wb = this.wb;
            var sortedlegalsans = wb.sortedLegalSanList().split("\n");
            sortedlegalsans.map(function (san) {
                movesdiv_1.a(new A_("#", san, legalmoveclicked.bind(_this, san)));
                movesdiv_1.a(new Br_());
            });
            movestd.a(movesdiv_1);
            var gametd = new Td_();
            var pgn = this.reportPgnStr();
            localStorage.setItem(this.pgnStoreKey(), pgn);
            localStorage.setItem("currentvariant", this.variant);
            var gamediv = new Div_().swspx(this.width()).shspx(this.totalheight() / 2.0).
                sff("monospace").sovf("scroll").html(pgn);
            var logdiv = new Div_("logdiv").swspx(this.width()).shspx(this.totalheight() / 2.0).
                sff("monospace").sovf("scroll").finalize();
            var loghtml = this.reportLogHtml();
            logdiv.innerHTML(loghtml);
            gametd.a(gamediv);
            gametd.a(logdiv);
            tr1.a(movestd);
            var tp = new TabPane_("tabs", this.width(), this.totalheight(), [
                new Tab("pgn", "PGN"),
                new Tab("log", "Log"),
                new Tab("san", "San"),
                new Tab("pres", "Pres"),
                new Tab("wlog", "wLog")
            ]);
            var pgncontrolsdiv = new Div_();
            var pgnkeytext = new Text_();
            var pgnvaluetext = new Text_();
            this.pgnkeyinput = pgnkeytext;
            this.pgnvalueinput = pgnvaluetext;
            var pgnheaderbutton = new Button_("Change", pgnheaderhandler.bind(this));
            var pgnprediv = new Div_().
                swspx(this.width()).
                sff("monospace").
                html("<hr>" + pgn.replace(new RegExp("\\n", "g"), "<br>"));
            pgncontrolsdiv.a(pgnkeytext).a(pgnvaluetext).a(pgnheaderbutton);
            var pgndiv = new Div_().a(pgncontrolsdiv).a(pgnprediv);
            tp.setNode_("pgn", pgndiv);
            tp.setContent("log", loghtml);
            var sidiv = new Div_();
            var si = new Text_();
            this.saninput = si;
            var sib = new Button_("Make", makesanhandler.bind(this));
            sidiv.a(si);
            sidiv.a(sib);
            tp.setNode_("san", sidiv);
            var presdiv = new Div_().
                swspx(this.width()).
                sff("monospace").
                finalize();
            var pcb = new Button_("Connect", connecthandler.bind(this));
            presdiv.a(pcb);
            this.presdiv = presdiv;
            var wlogdiv = new Div_().
                swspx(this.width()).
                sff("monospace").
                finalize();
            this.wlogdiv = wlogdiv;
            tp.setNode_("wlog", wlogdiv);
            tp.setNode_("pres", presdiv);
            tr1.a(tp);
            this.tabs = tp;
            //tr1.a(gametd)
            var infotd = new Td_(3);
            var t = new Textarea_(10);
            t.swspx(this.width() * (2 + 1 / 3)).finalize();
            this.fentext = t;
            infotd.a(t.setText(this.reportFen()));
            tr2.a(infotd);
            anchordiv.a(table);
            this.dragz = Board.DRAGGED_PIECE_Z_INDEX;
            wboarddraw.bind(this)();
        }
    }
    BoardDraw.draw = draw;
    function varianthandler(e) {
        var t = e.target;
        var selectedVariantId = t.selectedOptions[0].id;
        this.constructFromVariant(selectedVariantId);
    }
    function fliphandler(e) {
        this.flip += 1;
        if (this.flip > 3)
            this.flip = 0;
        this.draw();
    }
    function tobeginhandler(e) {
        this.toBegin();
        this.draw();
    }
    function backhandler(e) {
        this.back();
        this.draw();
    }
    function forwardhandler(e) {
        this.forward();
        this.draw();
    }
    function toEndhandler(e) {
        this.toEnd();
        this.draw();
    }
    function delhandler(e) {
        this.del();
        this.draw();
    }
    function resethandler(e) {
        if (this.enginerunning)
            this.stopanalysis();
        this.reset();
        this.wb.deleteGameInfo();
        this.draw();
    }
    function randomhandler(e) {
        if (this.randomon) {
            this.randomon = false;
            return;
        }
        this.randomon = true;
        makerandom.bind(this)();
    }
    BoardDraw.randomhandler = randomhandler;
    function analyzehandler(e) {
        this.analyze();
    }
    BoardDraw.analyzehandler = analyzehandler;
    function stopanalysishandler(e) {
        this.stopanalysis();
    }
    BoardDraw.stopanalysishandler = stopanalysishandler;
    function makeanalyzedmovehandler(e) {
        this.makeanalyzedmove();
    }
    BoardDraw.makeanalyzedmovehandler = makeanalyzedmovehandler;
    function starthandler(e) {
        this.startengine();
    }
    BoardDraw.starthandler = starthandler;
    function makerandom() {
        if (!this.randomon)
            return;
        var lms = this.legalMoves();
        if (lms.length > 0) {
            var ri = Math.floor(Math.random() * lms.length);
            if (ri >= lms.length) {
                ri = 0;
            }
            this.makeMove(lms[ri]);
            this.draw();
        }
        setTimeout(makerandom.bind(this), 110);
    }
    function boardmousemove(e) {
        var me = e;
        if (this.dragunderway) {
            var client = new ScreenVector(me.clientX, me.clientY);
            this.dragd = client.Minus(this.dragstart);
            var nsv = this.dragstartst.Plus(this.dragd);
            var st = new Div_().decomposestyle(doc.getStyleOfId(this.draggedid));
            st.slpx(nsv.x);
            st.stpx(nsv.y);
            st.szi(this.dragz);
            doc.setStyleOfId(this.draggedid, st.reportstyle());
        }
    }
    function boardmouseup(e) {
        var me = e;
        if (this.dragunderway) {
            this.dragunderway = false;
            var dragdcorr = this.dragd.Plus(this.HALF_SQUARE_SIZE_SCREENVECTOR.Scaled());
            var dragdnom = dragdcorr.UnScaled();
            var dsq = screenvectortosquare.bind(this)(dragdnom);
            var dsv = squaretoscreenvector.bind(this)(dsq).Scaled();
            var nsv = this.dragstartst.Plus(dsv);
            var st = new Div_().decomposestyle(doc.getStyleOfId(this.draggedid));
            st.slpx(nsv.x);
            st.stpx(nsv.y);
            doc.setStyleOfId(this.draggedid, st.reportstyle());
            var draggedalgeb = Utils.idpart(this.draggedid, 1);
            var fromsqorig = this.rotateSquare(this.algebToSquare(draggedalgeb), this.flip);
            var tosq = this.rotateSquare(fromsqorig.Plus(dsq), -this.flip);
            var toalgeb = this.squareToAlgeb(tosq);
            var moveToAlgeb = draggedalgeb + toalgeb;
            var m = this.algebToMove(moveToAlgeb);
            var rm = this.toRichMove(m, false);
            if (rm != null) {
                if (rm.promotion) {
                    var kind = prompt("Enter promotion piece letter [ n / b / r / q ] !");
                    if ((kind == "undefined") || (kind == null) || (kind == "")) { }
                    else if (this.cfg.promotionPieces.indexOf(kind) < 0)
                        alert("Invalid piece letter!");
                    else {
                        rm.prom = new Piece(kind, this.state.turn);
                        this.makeMove(rm);
                    }
                }
                else {
                    this.makeMove(rm);
                }
            }
            this.draw();
        }
    }
    function piecedragstart(pid, e) {
        var me = e;
        me.preventDefault();
        this.draggedid = pid;
        this.dragstart = new ScreenVector(me.clientX, me.clientY);
        this.dragz += 1;
        if (this.pids.indexOf(this.draggedid) >= 0) {
            var st = new Div_().decomposestyle(doc.getStyleOfId(this.draggedid));
            this.dragstartst = new ScreenVector(st.getpx("left"), st.getpx("top"));
            this.dragunderway = true;
        }
        else {
            console.log("wrong drag id: " + this.draggedid);
            this.draw();
        }
    }
    function legalmoveclicked(san, e) {
        this.makeSanMove(san);
        this.draw();
    }
    function makesanhandler(e) {
        var san = this.saninput.getText();
        this.log("making move " + san);
        var m = this.sanToMove(san);
        if (m == null) {
            this.log("invalid move");
            return;
        }
        var rm = this.toRichMove(m);
        if (rm == null) {
            this.log("illegal move");
            return;
        }
        this.makeMove(rm);
        this.draw();
    }
    function pgnheaderhandler(e) {
        var key = this.pgnkeyinput.getText();
        var value = this.pgnvalueinput.getText();
        if (value == "") {
            delete this.pgnHeaders[key];
        }
        else {
            this.pgnHeaders[key] = value;
        }
        this.draw();
    }
    function connecthandler(e) {
        this.connect();
    }
    function screenvectortosquare(sv) {
        var f = Math.floor(sv.x / this.SQUARE_SIZE);
        var r = Math.floor(sv.y / this.SQUARE_SIZE);
        return new Square(f, r);
    }
    function squaretoscreenvector(sq) {
        var x = sq.file * this.SQUARE_SIZE;
        var y = sq.rank * this.SQUARE_SIZE;
        return new ScreenVector(x, y);
    }
    function wboarddraw() {
        if (!this.HAS_WASM())
            return;
        var wb = this.wb;
        this.wlogdiv.innerHTML("<pre>" + wb.reportBoardText() + "</pre>" +
            wb.out(wb.OUTBUF2));
    }
})(BoardDraw || (BoardDraw = {}));
var BoardUtils;
(function (BoardUtils) {
    function setFromRawFen(fen) {
        for (var i = 0; i < this.cfg.area; i++) {
            var index = i * 2;
            var kind = fen[index];
            var color = +fen[index + 1];
            this.state.rep[i] = new Piece(kind, color);
        }
    }
    BoardUtils.setFromRawFen = setFromRawFen;
    function whereIsKing(color) {
        if (color === void 0) { color = this.state.turn; }
        var testking = new Piece("k", color);
        for (var i = 0; i < this.cfg.area; i++) {
            if (this.state.rep[i].equalto(testking))
                return this.squareOfIndex(i);
        }
        return null;
    }
    BoardUtils.whereIsKing = whereIsKing;
    function getEffectivePawnDirection(pd, dc) {
        var epd = new Square(pd.file, pd.rank);
        if (pd.file == 0) {
            epd.file = dc;
        }
        else if (pd.rank == 0) {
            epd.rank = dc;
        }
        return epd;
    }
    BoardUtils.getEffectivePawnDirection = getEffectivePawnDirection;
    function isPieceAttackedAtSquare(p, sq) {
        if (p.kind == "p") {
            for (var col = 0; col < this.cfg.numPlayers; col++)
                if (col != p.color) {
                    var pd = this.cfg.pawnDirectionsByColor[col];
                    for (var dc = -1; dc <= 1; dc += 2) {
                        var epd = this.getEffectivePawnDirection(pd, dc);
                        var tsq = sq.Minus(epd);
                        if (this.isSquareValid(tsq)) {
                            var p_1 = this.getPieceAtSquare(tsq);
                            if ((p_1.kind == "p") && (p_1.color == col))
                                return true;
                        }
                    }
                }
        }
        else {
            var _a = this.pseudoLegalMovesForPieceAtSquare(p, sq, true, p.kind), moves = _a[0], capture = _a[1];
            if (capture)
                return true;
        }
        return false;
    }
    BoardUtils.isPieceAttackedAtSquare = isPieceAttackedAtSquare;
    function isSquareAttacked(sq, color) {
        if (color === void 0) { color = this.state.turn; }
        var kinds = this.cfg.allPieces;
        for (var i in kinds) {
            var testpiece = new Piece(kinds[i], color);
            if (this.isPieceAttackedAtSquare(testpiece, sq))
                return true;
        }
        return false;
    }
    BoardUtils.isSquareAttacked = isSquareAttacked;
    function isColorInCheck(color) {
        if (color === void 0) { color = this.state.turn; }
        var wk = this.whereIsKing(color);
        if (wk == null)
            return true;
        return this.isSquareAttacked(wk, color);
    }
    BoardUtils.isColorInCheck = isColorInCheck;
    function squareOfIndex(i) {
        var f = (i % this.cfg.numFiles);
        var r = Math.floor(i / this.cfg.numFiles);
        return new Square(f, r);
    }
    BoardUtils.squareOfIndex = squareOfIndex;
    function squareHasPieceOfColor(sq, color, exclude) {
        if (exclude === void 0) { exclude = false; }
        if (!this.isSquareValid(sq))
            return false;
        var p = this.getPieceAtSquare(sq);
        if (p.empty())
            return false;
        if (exclude)
            return p.color != color;
        return p.color == color;
    }
    BoardUtils.squareHasPieceOfColor = squareHasPieceOfColor;
    function rotateSquare(sq, rot) {
        if (rot == 0) {
            return sq;
        }
        if (rot < 0) {
            rot = 4 + rot;
        }
        if (rot == 1) {
            return new Square(this.cfg.lastRank - sq.rank, sq.file);
        }
        if (rot == 2) {
            return new Square(this.cfg.lastFile - sq.file, this.cfg.lastRank - sq.rank);
        }
        return new Square(sq.rank, this.cfg.lastFile - sq.file);
    }
    BoardUtils.rotateSquare = rotateSquare;
    function squareToAlgeb(sq) {
        var fl = Utils.FILE_TO_FILE_LETTER[sq.file];
        var rl = "" + (this.cfg.numRanks - sq.rank);
        return fl + rl;
    }
    BoardUtils.squareToAlgeb = squareToAlgeb;
    function fileLetterToFile(fl) {
        return Utils.FILE_LETTER_TO_FILE[fl];
    }
    BoardUtils.fileLetterToFile = fileLetterToFile;
    function rankLetterToRank(b, rl) {
        return (b.cfg.numRanks - parseInt(rl));
    }
    BoardUtils.rankLetterToRank = rankLetterToRank;
    function algebToSquare(algeb) {
        var t = new Utils.Tokenizer(algeb);
        var fl = t.pull(Utils.FILE_LETTER);
        var rl = t.pull(Utils.RANK_LETTER);
        var f = fileLetterToFile(fl);
        var r = rankLetterToRank(this, rl);
        return new Square(f, r);
    }
    BoardUtils.algebToSquare = algebToSquare;
    function algebToMove(algeb) {
        var t = new Utils.Tokenizer(algeb);
        var fromalgeb = t.pull(Utils.FILE_LETTER) + t.pull(Utils.RANK_LETTER);
        var toalgeb = t.pull(Utils.FILE_LETTER) + t.pull(Utils.RANK_LETTER);
        var promalgeb = t.pull(this.cfg.promotionPieces);
        var fromsq = this.algebToSquare(fromalgeb);
        var tosq = this.algebToSquare(toalgeb);
        if (promalgeb == "")
            return new Move(fromsq, tosq);
        return new Move(fromsq, tosq, new Piece(promalgeb, this.state.turn));
    }
    BoardUtils.algebToMove = algebToMove;
    function moveToAlgeb(m, info) {
        if (info === void 0) { info = false; }
        var algeb = this.squareToAlgeb(m.fromsq) + this.squareToAlgeb(m.tosq);
        if (!m.prom.empty()) {
            algeb += m.prom.kind;
        }
        if (info) {
            var infostr = m.info();
            if (infostr != "")
                algeb += " " + infostr;
        }
        return algeb;
    }
    BoardUtils.moveToAlgeb = moveToAlgeb;
    function isSquareValid(sq) {
        if (this.IS_FOUR_PLAYER()) {
            if ((sq.file < 3) && (sq.rank < 3))
                return false;
            if ((sq.file < 3) && (sq.rank > 10))
                return false;
            if ((sq.file > 10) && (sq.rank > 10))
                return false;
            if ((sq.file > 10) && (sq.rank < 3))
                return false;
        }
        if ((sq.file < 0) || (sq.file > this.cfg.lastFile))
            return false;
        if ((sq.rank < 0) || (sq.rank > this.cfg.lastRank))
            return false;
        return true;
    }
    BoardUtils.isSquareValid = isSquareValid;
    function toNode(gn, incremental) {
        if (incremental === void 0) { incremental = false; }
        incremental = false;
        if (!incremental) {
            this.current = gn;
            this.setFromFen(gn.fen);
        }
        else {
            var algebs = [];
            while (gn.parent != null) {
                algebs.push(gn.genalgeb);
                gn = gn.parent;
            }
            algebs.reverse();
            this.setFromFen(this.startfen);
            this.current = this.root;
            for (var ai in algebs) {
                var algeb = algebs[ai];
                var m = this.algebToMove(algeb);
                var rm = this.toRichMove(m);
                this.makeMove(rm);
            }
        }
    }
    BoardUtils.toNode = toNode;
    function toBegin() {
        this.toNode(this.root);
        this.wb.tobegin();
    }
    BoardUtils.toBegin = toBegin;
    function back() {
        if (this.current.parent != null) {
            this.toNode(this.current.parent);
        }
        this.wb.back();
    }
    BoardUtils.back = back;
    function forward() {
        if (this.current.haschild()) {
            this.toNode(this.current.mainchild());
        }
        this.wb.forward();
    }
    BoardUtils.forward = forward;
    function toEnd() {
        while (this.current.haschild()) {
            this.current = this.current.mainchild();
        }
        this.toNode(this.current);
        this.wb.toend();
    }
    BoardUtils.toEnd = toEnd;
})(BoardUtils || (BoardUtils = {}));
/////////////////////////////////////////////////////////////////////////
var ScreenVector = Utils.ScreenVector;
var doc = Node_Globals.doc;
/////////////////////////////////////////////////////////////////////////
var EngineMessage = /** @class */ (function () {
    function EngineMessage() {
    }
    EngineMessage.prototype._action = function (_action) { this.action = _action; return this; };
    EngineMessage.prototype._command = function (_command) { this.command = _command; return this; };
    EngineMessage.prototype._name = function (_name) { this.name = _name; return this; };
    EngineMessage.prototype.parseJson = function (data) {
        var pd = JSON.parse(data);
        this.action = pd.action;
        this.available = pd.available;
        this.buffer = pd.buffer;
        return this;
    };
    return EngineMessage;
}());
var Board = /** @class */ (function () {
    /////////////////////////////////////////////////////////////////////////
    function Board() {
        /////////////////////////////////////////////////////////////////////////
        this.variant = "standard";
        this.anchorid = "";
        this.purpose = "test";
        this.mainlog = new GlobalUtils.Logger();
        this.connectid = 0;
        this.tolog = new GlobalUtils.Logger();
        this.enginerunning = false;
    }
    Board.prototype.Variant = function (_variant) { this.variant = _variant; return this; };
    Board.prototype.AnchorId = function (_anchorId) { this.anchorid = _anchorId; return this; };
    Board.prototype.Main = function () { this.purpose = "main"; return this; };
    Board.prototype.wConstruct = function (callback) {
        this.wb = new wBoard(this.Construct.bind(this, callback));
    };
    Board.prototype.Construct = function (callback) {
        if (callback === void 0) { callback = null; }
        if (this.variant == undefined)
            this.variant = Board.DEFAULT_VARIANT;
        if (this.anchorid == undefined)
            this.anchorid = "";
        if (this.purpose == undefined)
            this.purpose = "test";
        this.cfg = Config.chessConfigurationManager.getConfigurationByVariantId(this.variant);
        /////////////////////////////////////////////////////////////////////////
        // initialize board state once by hand in order to establish the start fen
        if (this.HAS_WASM()) {
            this.wb.newBoard(this.variantCode());
        }
        this.state = new BoardState();
        this.state.rep = new Array(this.cfg.area);
        this.state.turn = 1;
        this.setFromRawFen(this.cfg.startRawFen);
        this.createCastlingRegistries();
        this.state.setEpSquares([]);
        this.state.fullmove_number = 1;
        this.state.halfmove_clock = 0;
        /////////////////////////////////////////////////////////////////////////
        // calculate start fen
        this.startfen = this.reportFen();
        /////////////////////////////////////////////////////////////////////////
        // initialize game
        this.root = new GameNode();
        this.root.fen = this.startfen;
        this.current = this.root;
        this.setDefaultPgnHeaders();
        /////////////////////////////////////////////////////////////////////////
        this.SQUARE_SIZE = (Board.DEFAULT_BOARD_SIZE / this.cfg.numRanks);
        this.SQUARE_PADDING = (this.SQUARE_SIZE / 10.0);
        this.PIECE_SIZE = (this.SQUARE_SIZE - 2 * this.SQUARE_PADDING);
        this.HALF_SQUARE_SIZE = (this.SQUARE_SIZE / 2.0);
        this.HALF_SQUARE_SIZE_SCREENVECTOR = new ScreenVector(this.HALF_SQUARE_SIZE, this.HALF_SQUARE_SIZE);
        this.BOARD_MARGIN = (Board.DEFAULT_BOARD_SIZE / 50.0);
        // when called for variant change, preserve flip
        if (this.flip == undefined) {
            this.flip = 0;
        }
        this.randomon = false;
        /////////////////////////////////////////////////////////////////////////
        if (callback != null)
            callback(this);
        /////////////////////////////////////////////////////////////////////////
        return this;
    };
    Board.prototype.reset = function () {
        this.setFromFen(this.startfen);
        this.setDefaultPgnHeaders();
        this.root = new GameNode();
        this.root.fen = this.reportFen();
        this.current = this.root;
        this.randomon = false;
    };
    Board.prototype.setFromStandardFen = function (fen) {
        var parts = fen.split(" ");
        var rawfen = parts[0];
        var turnfen = parts[1];
        var castlefen = parts[2];
        var epfen = parts[3];
        var halfmovefen = parts[4];
        var fullmovefen = parts[5];
        var rawfenchars = rawfen.split("");
        var i = 0;
        for (var ri in rawfenchars) {
            var c = rawfenchars[ri];
            if (c != "/") {
                var n = parseInt(c);
                if (!isNaN(n)) {
                    while (n > 0) {
                        this.state.rep[i] = new Piece();
                        n--;
                        i++;
                    }
                }
                else {
                    var kind = c;
                    var color = 0;
                    if (c == c.toUpperCase()) {
                        kind = c.toLowerCase();
                        color = 1;
                    }
                    var p = new Piece(kind, color);
                    this.state.rep[i] = p;
                    i++;
                }
            }
        }
        this.state.turn = (turnfen == "w" ? 1 : 0);
        this.state.castlingRights = [[false, false], [false, false]];
        var castlechars = castlefen.split("");
        for (var ci in castlechars) {
            var c = castlechars[ci];
            switch (c) {
                case "K":
                    this.state.castlingRights[1][1] = true;
                    break;
                case "Q":
                    this.state.castlingRights[1][0] = true;
                    break;
                case "k":
                    this.state.castlingRights[0][0] = true;
                    break;
                case "q":
                    this.state.castlingRights[0][1] = true;
                    break;
            }
        }
        this.state.epSquares = [];
        if (epfen != "-") {
            var sq = this.algebToSquare(epfen);
            var pdir = this.cfg.pawnDirectionsByColor[1 - this.state.turn];
            var clsq = sq.Plus(pdir);
            var epsq = new EpSquare(sq, clsq, 0, 1 - this.state.turn);
            this.state.epSquares.push(epsq);
        }
        this.state.halfmove_clock = parseInt(halfmovefen);
        this.state.fullmove_number = parseInt(fullmovefen);
        if (this.HAS_WASM()) {
            this.setWBoard();
        }
    };
    Board.prototype.setWBoard = function () {
        this.wb.setFromRawFen(this.reportRawFen());
        this.wb.setTurn(this.state.turn);
        this.wb.setFullmoveNumber(this.state.fullmove_number);
        this.wb.setHalfmoveClock(this.state.halfmove_clock);
        this.wb.resetEpSquares();
        for (var ei in this.state.epSquares) {
            var epsq = this.state.epSquares[ei];
            this.wb.setEpSquare(epsq.color, epsq.sq.file, epsq.sq.rank, epsq.clsq.file, epsq.clsq.rank, epsq.cnt);
        }
        this.wb.resetCastlingRegistries();
        for (var ci = 0; ci < this.cfg.numPlayers; ci++)
            for (var cs = 0; cs < 2; cs++) {
                var right = this.state.castlingRights[ci][cs];
                var cr = this.castlingRegistries[ci][cs];
                this.wb.setCastlingRegistry(ci, cs, right ? 1 : 0, cr.kingSquare.file, cr.kingSquare.rank, cr.rookSquare.file, cr.rookSquare.rank);
                for (var ei = 0; ei < cr.emptySquares.length; ei++) {
                    this.wb.setCastlingRegistryEmpty(ci, cs, ei, cr.emptySquares[ei].file, cr.emptySquares[ei].rank);
                }
                for (var pi = 0; pi < cr.passingSquares.length; pi++) {
                    this.wb.setCastlingRegistryPassing(ci, cs, pi, cr.passingSquares[pi].file, cr.passingSquares[pi].rank);
                }
            }
    };
    Board.prototype.setFromFen = function (fen) {
        if (this.cfg.standardReportable) {
            this.setFromStandardFen(fen);
            return;
        }
        var rbs = JSON.parse(fen);
        this.setFromRawFen(rbs.rawfen);
        this.state.update(rbs);
        if (this.HAS_WASM()) {
            this.setWBoard();
        }
    };
    Board.prototype.reportRawFen = function () {
        var buffer = "";
        for (var i = 0; i < this.cfg.area; i++)
            buffer += this.state.rep[i].algeb();
        return buffer;
    };
    Board.prototype.reportStandardFen = function () {
        var fen = "";
        var cumul = 0;
        for (var i = 0; i < this.cfg.area; i++) {
            var col = (i % 8);
            var sep = (i < this.cfg.area - 1 ? "/" : "");
            var p = this.state.rep[i];
            if (p.empty()) {
                cumul++;
                if (col == 7) {
                    fen += cumul + sep;
                    cumul = 0;
                }
            }
            else {
                if (cumul > 0)
                    fen += cumul;
                cumul = 0;
                var epkind = (p.color == 0) ? p.kind : p.kind.toUpperCase();
                if (col == 7) {
                    fen += epkind + sep;
                }
                else {
                    fen += epkind;
                }
            }
        }
        fen += " " + (this.state.turn == 1 ? "w" : "b") + " ";
        var crs = this.state.castlingRights;
        var castlefen = "";
        if (crs[1][1])
            castlefen += "K";
        if (crs[1][0])
            castlefen += "Q";
        if (crs[0][0])
            castlefen += "k";
        if (crs[0][1])
            castlefen += "q";
        if (castlefen == "")
            castlefen = "-";
        fen += castlefen;
        if (this.state.epSquares.length > 0) {
            fen += " " + this.squareToAlgeb(this.state.epSquares[0].sq);
        }
        else
            fen += " -";
        fen += " " + this.state.halfmove_clock + " " + this.state.fullmove_number;
        return fen;
    };
    Board.prototype.reportFen = function () {
        if (this.cfg.standardReportable)
            return this.reportStandardFen();
        var rbs = new ReportableBoardState(this.reportRawFen(), this.state);
        return JSON.stringify(rbs);
    };
    Board.prototype.makeMove = function (m, updategame) {
        if (updategame === void 0) { updategame = true; }
        if (this.HAS_WASM()) {
            this.wb.makeMove(m);
        }
        var algeb = this.moveToAlgeb(m);
        var san = updategame ? this.moveToSan(m) : null;
        var turn = this.state.turn;
        var frompiece = this.getPieceAtSquare(m.fromsq);
        var topiece = this.getPieceAtSquare(m.tosq);
        // clear original square
        this.setPieceAtSquare(m.fromsq, new Piece());
        if (m.castling) {
            // clear rook square
            this.setPieceAtSquare(m.tosq, new Piece());
            var dir = m.tosq.Minus(m.fromsq).Normalize();
            // determine destination squares
            var kingdestsq = m.fromsq.Plus(dir).Plus(dir);
            var rookdestsq = kingdestsq.Minus(dir);
            // put king and rook
            this.setPieceAtSquare(kingdestsq, new Piece("k", turn));
            this.setPieceAtSquare(rookdestsq, new Piece("r", turn));
        }
        else {
            // determine destination piece
            var destpiece = frompiece;
            if (!m.prom.empty()) {
                destpiece = m.prom;
            }
            // put piece on destination square
            this.setPieceAtSquare(m.tosq, destpiece);
        }
        // ep clear square
        if (m.epclsq != undefined) {
            this.setPieceAtSquare(m.epclsq, new Piece());
            for (var ei = 0; ei < this.state.getNumEpSquares(); ei++) {
                var esq = this.state.getEpSquare(ei);
                if (esq.isEqualToSq(m.epclsq)) {
                    esq.cnt = 0;
                    this.state.setEpSquare(ei, esq);
                }
            }
        }
        // update ep squares
        if (m.epsq != undefined) {
            this.state.pushEpSquare(m.epsq);
        }
        var newepsqs = [];
        for (var ei = 0; ei < this.state.getNumEpSquares(); ei++) {
            var esq = this.state.getEpSquare(ei);
            if (esq.canDecrease())
                newepsqs.push(esq);
        }
        this.state.setEpSquares(newepsqs);
        // handle atomic explosions        
        if (this.IS_ATOMIC())
            if (m.capture) {
                for (var f = -1; f <= 1; f++)
                    for (var r = -1; r <= 1; r++) {
                        var sq = m.tosq.Plus(new Square(f, r));
                        if (this.isSquareValid(sq)) {
                            var testp = this.getPieceAtSquare(sq);
                            if (!testp.empty()) {
                                if (testp.kind != "p") {
                                    this.setPieceAtSquare(sq, new Piece());
                                }
                            }
                        }
                    }
            }
        // check if move cancels castling rights        
        for (var ci = 0; ci < this.cfg.numPlayers; ci++)
            for (var side = 0; side <= 1; side++)
                if (this.state.castlingRights[ci][side]) {
                    var ksq = this.castlingRegistries[ci][side].kingSquare;
                    var rsq = this.castlingRegistries[ci][side].rookSquare;
                    var testk = this.getPieceAtSquare(ksq);
                    var testr = this.getPieceAtSquare(rsq);
                    if ((testk.kind != 'k') ||
                        (testk.color != ci) ||
                        (testr.kind != 'r') ||
                        (testr.color != ci))
                        this.state.castlingRights[ci][side] = false;
                }
        // advance turn
        this.advanceTurn();
        // advance halfmove clock
        this.state.halfmove_clock++;
        if (m.capture || m.pawnmove)
            this.state.halfmove_clock = 0;
        // advance fullmove number
        if (this.state.turn == 1)
            this.state.fullmove_number++;
        if (updategame) {
            this.current.childs = {};
            // update game                                
            if (!this.current.has(san)) {
                var gn = new GameNode();
                gn.fen = this.reportFen();
                gn.genalgeb = algeb;
                gn.gensan = san;
                gn.parent = this.current;
                gn.fullmove_number = this.state.fullmove_number;
                gn.turn = this.state.turn;
                this.current.childs[san] = gn;
            }
            this.current = this.current.childs[san];
            // restart analysis if necessary
            if (this.enginerunning) {
                this.analyze();
            }
        }
    };
    Board.prototype.advanceTurn = function () {
        this.advanceTurnOnce();
    };
    Board.prototype.isMoveLegal = function (m) { return this.toRichMove(m) != null; };
    Board.prototype.toRichMove = function (m, strict) {
        if (strict === void 0) { strict = true; }
        var p = this.getPieceAtSquare(m.fromsq);
        if (p.color != this.state.turn)
            return null;
        var lms = this.legalMoves([p, m]);
        for (var i in lms) {
            var cm = lms[i];
            var ok = cm.isEqualTo(m);
            if (!strict)
                ok = cm.isRoughlyEqualTo(m);
            if (ok) {
                return cm;
            }
        }
        return null;
    };
    Board.prototype.legalMoves = function (limitTo) {
        if (limitTo === void 0) { limitTo = null; }
        var pseudoLegalMoves;
        if (limitTo == null)
            pseudoLegalMoves = this.pseudoLegalMoves();
        else
            pseudoLegalMoves = this.pseudoLegalMovesForPieceAtSquare(limitTo[0], limitTo[1].fromsq)[0];
        var lmoves = [];
        var wk = this.whereIsKing();
        if (wk != null) {
            var iskingmove = (limitTo == null) || (wk.isEqualTo(limitTo[1].fromsq));
            if (iskingmove) {
                // castling moves
                for (var side = 0; side <= 1; side++) {
                    var turn = this.state.turn;
                    if (this.state.castlingRights[turn][side]) {
                        var cr = this.castlingRegistries[turn][side];
                        var esok = true;
                        for (var esi in cr.emptySquares) {
                            var esq = cr.emptySquares[esi];
                            if (!this.isSquareEmpty(esq)) {
                                esok = false;
                                break;
                            }
                        }
                        if (esok) {
                            var psok = true;
                            for (var psi in cr.passingSquares) {
                                var psq = cr.passingSquares[psi];
                                if (this.isSquareAttacked(psq)) {
                                    psok = false;
                                    break;
                                }
                            }
                            if (psok) {
                                lmoves.push(new Move(cr.kingSquare, cr.rookSquare).
                                    Castling());
                            }
                        }
                    }
                }
            }
        }
        // other pseudo legal moves        
        for (var i in pseudoLegalMoves) {
            var testm = pseudoLegalMoves[i];
            if ((limitTo == null) || (testm.isRoughlyEqualTo(limitTo[1]))) {
                var testb = new Board().Variant(this.variant).Construct();
                testb.setFromFen(this.reportFen());
                testb.makeMove(testm, false);
                if (!testb.isColorInCheck(this.state.turn))
                    lmoves.push(testm);
            }
        }
        return lmoves;
    };
    Board.prototype.pseudoLegalMoves = function () {
        var moves = [];
        for (var f = 0; f < this.cfg.numFiles; f++) {
            for (var r = 0; r < this.cfg.numRanks; r++) {
                var sq = new Square(f, r);
                var p = this.getPieceAtSquare(sq);
                if (p.color == this.state.turn) {
                    var _a = this.pseudoLegalMovesForPieceAtSquare(p, sq), ms = _a[0], capture = _a[1];
                    moves = moves.concat(ms);
                }
            }
        }
        return moves;
    };
    Board.prototype.pseudoLegalMovesForPieceAtSquare = function (p, sq, stopatfirstcapture, capturekind // has to be set if stopatfirstcapture is true
    ) {
        if (stopatfirstcapture === void 0) { stopatfirstcapture = false; }
        if (capturekind === void 0) { capturekind = null; } // has to be set if stopatfirstcapture is true
        var moves = [];
        if (p.kind == "p") {
            var pdir = this.cfg.pawnDirectionsByColor[p.color];
            var basepawn = (!(this.isSquareValid(sq.Minus(pdir).Minus(pdir))));
            var aheadsq = sq.Plus(pdir);
            var pushbytwosq = aheadsq.Plus(pdir);
            if (this.isSquareValid(aheadsq)) {
                if (this.isSquareEmpty(aheadsq)) {
                    // pawn push by one square
                    if (this.isSquareValid(pushbytwosq)) {
                        // normal push
                        moves.push(new Move(sq, aheadsq).
                            PawnPush(1));
                    }
                    else {
                        // promotion pushes
                        for (var ppi in this.cfg.promotionPieces) {
                            var kind = this.cfg.promotionPieces[ppi];
                            // promotion push
                            moves.push(new Move(sq, aheadsq, new Piece(kind, p.color)).
                                PawnPush(1));
                        }
                    }
                    if (basepawn) {
                        if (this.isSquareValid(pushbytwosq)) {
                            if (this.isSquareEmpty(pushbytwosq)) {
                                // pawn push by two squares                                
                                moves.push(new Move(sq, pushbytwosq).
                                    PawnPush(2).
                                    EpSquare(new EpSquare(aheadsq, pushbytwosq, this.cfg.lastPlayer, p.color)));
                            }
                        }
                    }
                }
            }
            for (var dc = -1; dc <= 1; dc += 2) {
                var epd = this.getEffectivePawnDirection(pdir, dc);
                var capsq = sq.Plus(epd);
                if (this.isSquareValid(capsq)) {
                    if (this.isSquareEmpty(capsq)) {
                        for (var ei = 0; ei < this.state.getNumEpSquares(); ei++) {
                            var esq = this.state.getEpSquare(ei);
                            if (esq.isEqualToSq(capsq)) {
                                // ep capture
                                var epclsq = capsq.Minus(pdir);
                                moves.push(new Move(sq, capsq).
                                    EpClearSquare(esq.clsq));
                            }
                        }
                    }
                    else if (this.squareHasPieceOfColor(capsq, p.color, true)) {
                        // pawn capture
                        var captureaheadsq = capsq.Plus(pdir);
                        if (this.isSquareValid(captureaheadsq)) {
                            // normal capture
                            moves.push(new Move(sq, capsq).
                                PawnCapture());
                        }
                        else {
                            // promotion captures
                            for (var ppi in this.cfg.promotionPieces) {
                                var kind = this.cfg.promotionPieces[ppi];
                                // promotion capture
                                moves.push(new Move(sq, capsq, new Piece(kind, p.color)).
                                    PawnCapture());
                            }
                        }
                        if (stopatfirstcapture) {
                            if (this.getPieceAtSquare(capsq).kind == capturekind) {
                                return [moves, true];
                            }
                        }
                    }
                }
            }
        }
        else {
            var mvs = Config.getMovevectorsByPieceKind(p.kind);
            for (var i in mvs) {
                var mv = mvs[i];
                var csq = sq;
                while (this.isSquareValid(csq.Plus(mv))) {
                    csq = csq.Plus(mv);
                    if (this.squareHasPieceOfColor(csq, p.color))
                        break;
                    if (this.isSquareEmpty(csq)) {
                        // piece move to empty square
                        moves.push(new Move(sq, csq));
                    }
                    else if (this.squareHasPieceOfColor(csq, p.color, true)) {
                        // piece capture
                        moves.push(new Move(sq, csq).
                            Capture());
                        if (stopatfirstcapture) {
                            if (this.getPieceAtSquare(csq).kind == capturekind) {
                                return [moves, true];
                            }
                        }
                        break;
                    }
                    if (this.isNonSliding(p))
                        break;
                }
            }
        }
        return [moves, false];
    };
    // draw
    Board.prototype.node_ = function () { return BoardDraw.node_.bind(this)(); };
    Board.prototype.draw = function () {
        var t = new GlobalUtils.Timer("draw", this.log.bind(this));
        BoardDraw.draw.bind(this)();
        t.report();
    };
    // utils
    Board.prototype.width = function () { return this.cfg.numFiles * this.SQUARE_SIZE; };
    Board.prototype.totalwidth = function () { return this.width() + 2 * this.BOARD_MARGIN; };
    Board.prototype.height = function () { return this.cfg.numRanks * this.SQUARE_SIZE; };
    Board.prototype.totalheight = function () { return this.height() + 2 * this.BOARD_MARGIN; };
    Board.prototype.indexOf = function (f, r) { return f + this.cfg.numFiles * r; };
    Board.prototype.getPieceAtSquare = function (sq) { return this.state.rep[this.indexOf(sq.file, sq.rank)]; };
    Board.prototype.setPieceAtSquare = function (sq, p) { this.state.rep[this.indexOf(sq.file, sq.rank)] = p; };
    Board.prototype.isSquareEmpty = function (sq) { return this.getPieceAtSquare(sq).empty(); };
    Board.prototype.advanceTurnOnce = function () { this.state.turn = this.cfg.turnAdvancer[this.state.turn]; };
    Board.prototype.IS_FOUR_PLAYER = function () { return this.variant == "fourplayer"; };
    Board.prototype.IS_ATOMIC = function () { return this.variant == "atomic"; };
    Board.prototype.IS_MAIN = function () { return (this.purpose == "main"); };
    Board.prototype.HAS_WASM = function () { return this.wb != undefined; };
    Board.prototype.isNonSliding = function (p) { return ((p.kind == "k") || (p.kind == "n") || (p.kind == "p")); };
    Board.prototype.movesAlgeb = function (moves) {
        var _this = this;
        return moves.map(function (m) { return _this.moveToAlgeb(m); });
    };
    Board.prototype.legalMovesAlgeb = function () { return this.movesAlgeb(this.legalMoves()); };
    Board.prototype.variantCode = function () { return this.cfg.variantCode; };
    Board.prototype.setFromRawFen = function (fen) {
        BoardUtils.setFromRawFen.bind(this)(fen);
        if (this.HAS_WASM()) {
            this.wb.setFromRawFen(fen);
        }
    };
    Board.prototype.whereIsKing = function (color) {
        if (color === void 0) { color = this.state.turn; }
        return BoardUtils.whereIsKing.bind(this)(color);
    };
    Board.prototype.getEffectivePawnDirection = function (pd, dc) { return BoardUtils.getEffectivePawnDirection.bind(this)(pd, dc); };
    Board.prototype.isPieceAttackedAtSquare = function (p, sq) { return BoardUtils.isPieceAttackedAtSquare.bind(this)(p, sq); };
    Board.prototype.isSquareAttacked = function (sq, color) {
        if (color === void 0) { color = this.state.turn; }
        return BoardUtils.isSquareAttacked.bind(this)(sq, color);
    };
    Board.prototype.isColorInGlobalCheck = function (color) {
        if (color === void 0) { color = this.state.turn; }
        if (this.IS_ATOMIC()) {
            var wk = this.whereIsKing(color);
            if (wk == null)
                return true;
        }
        return false;
    };
    Board.prototype.adjacentKings = function () {
        var wkw = this.whereIsKing(1);
        if (wkw == null)
            return false;
        var wkb = this.whereIsKing(0);
        if (wkb == null)
            return false;
        var df = Math.abs(wkw.file - wkb.file);
        var dr = Math.abs(wkw.rank - wkb.rank);
        return ((df <= 1) && (dr <= 1));
    };
    Board.prototype.isColorInCheck = function (color, globalcheck) {
        if (color === void 0) { color = this.state.turn; }
        if (globalcheck === void 0) { globalcheck = true; }
        if (globalcheck) {
            if (this.isColorInGlobalCheck(color))
                return true;
        }
        if (this.IS_ATOMIC()) {
            if (this.adjacentKings())
                return false;
        }
        return BoardUtils.isColorInCheck.bind(this)(color);
    };
    Board.prototype.squareOfIndex = function (i) { return BoardUtils.squareOfIndex.bind(this)(i); };
    Board.prototype.squareHasPieceOfColor = function (sq, color, exclude) {
        if (exclude === void 0) { exclude = false; }
        return BoardUtils.squareHasPieceOfColor.bind(this)(sq, color, exclude);
    };
    Board.prototype.rotateSquare = function (sq, rot) { return BoardUtils.rotateSquare.bind(this)(sq, rot); };
    Board.prototype.squareToAlgeb = function (sq) { return BoardUtils.squareToAlgeb.bind(this)(sq); };
    Board.prototype.algebToSquare = function (algeb) { return BoardUtils.algebToSquare.bind(this)(algeb); };
    Board.prototype.algebToMove = function (algeb) { return BoardUtils.algebToMove.bind(this)(algeb); };
    Board.prototype.moveToAlgeb = function (m, info) {
        if (info === void 0) { info = false; }
        return BoardUtils.moveToAlgeb.bind(this)(m, info);
    };
    Board.prototype.isSquareValid = function (sq) { return BoardUtils.isSquareValid.bind(this)(sq); };
    Board.prototype.toNode = function (gn, incremental) {
        if (incremental === void 0) { incremental = false; }
        BoardUtils.toNode.bind(this)(gn, incremental);
        if (this.enginerunning) {
            this.analyze();
        }
    };
    Board.prototype.toBegin = function () { BoardUtils.toBegin.bind(this)(); };
    Board.prototype.back = function () { BoardUtils.back.bind(this)(); };
    Board.prototype.forward = function () { BoardUtils.forward.bind(this)(); };
    Board.prototype.toEnd = function () { BoardUtils.toEnd.bind(this)(); };
    Board.prototype.del = function () {
        if (this.current.parent != null) {
            this.toNode(this.current.parent);
        }
        this.current.childs = {};
        this.wb["delete"]();
    };
    Board.prototype.squaresBetween = function (sq1, sq2, withextremes) {
        if (withextremes === void 0) { withextremes = false; }
        var dir = sq2.Minus(sq1).Normalize();
        if (dir == null)
            return null;
        var between = [];
        var csq = sq1;
        do {
            if (csq.isEqualTo(sq2)) {
                if (withextremes)
                    between.push(csq);
                return between;
            }
            if ((csq != sq1) || (withextremes))
                between.push(csq);
            csq = csq.Plus(dir);
        } while (this.isSquareValid(csq));
        return null;
    };
    Board.prototype.createCastlingRegistries = function () {
        if (this.state.castlingRights == undefined)
            this.state.castlingRights = new Array(this.cfg.numPlayers);
        this.castlingRegistries = new Array(this.cfg.numPlayers);
        for (var color = 0; color < this.cfg.numPlayers; color++) {
            if (this.state.castlingRights[color] == undefined)
                this.state.castlingRights[color] = [true, true];
            var cregs = new Array(2);
            var wk = this.whereIsKing(color);
            if (wk != null) {
                for (var side = 0; side <= 1; side++) {
                    if (this.state.castlingRights[color][side]) {
                        var dir = this.cfg.pawnDirectionsByColor[color].Rotate(side == 0 ? 1 : -1);
                        var csq = wk;
                        var lastrooksq = null;
                        do {
                            var p = this.getPieceAtSquare(csq);
                            if ((p.kind == "r") && (p.color == color))
                                lastrooksq = csq;
                            csq = csq.Plus(dir);
                        } while (this.isSquareValid(csq));
                        if (lastrooksq == null)
                            this.state.castlingRights[color][side] = false;
                        else {
                            var emptysquares = this.squaresBetween(wk, lastrooksq);
                            var kingtargetsq = wk.Plus(dir).Plus(dir);
                            var passingsquares = this.squaresBetween(wk, kingtargetsq, true);
                            var reg = new CastlingRegistry(wk, lastrooksq, emptysquares, passingsquares);
                            cregs[side] = reg;
                        }
                    }
                }
                this.castlingRegistries[color] = cregs;
            }
            else {
                this.state.castlingRights[color] = [false, false];
            }
        }
    };
    Board.prototype.setFromTreeNodeRecursive = function (tn) {
        for (var san in tn.moves) {
            var m = this.sanToMove(san);
            if (m == null)
                console.log("invalid move " + san);
            else {
                var rm = this.toRichMove(m);
                if (rm == null)
                    console.log("illegal move" + san);
                else {
                    this.allnodes++;
                    this.makeMove(rm);
                    this.setFromTreeNodeRecursive(tn.moves[san]);
                    this.back();
                }
            }
        }
        if (tn.current)
            this.savedCurrent = this.current;
    };
    Board.prototype.setFromTreeNode = function (tn) {
        this.allnodes = 0;
        this.reset();
        this.savedCurrent = undefined;
        this.setFromTreeNodeRecursive(tn);
        if (this.savedCurrent != undefined)
            this.toNode(this.savedCurrent, true);
    };
    Board.prototype.reportTree = function () {
        return this.root.reportTreeNode(this.current);
    };
    Board.prototype.reportPgn = function () {
        var pgn = new Pgn();
        pgn.variant = this.variant;
        pgn.headers = this.pgnHeaders;
        pgn.tree = this.reportTree();
        return pgn;
    };
    Board.prototype.reportPgnHeadersStr = function () {
        var headers = [];
        for (var key in this.pgnHeaders) {
            var value = this.pgnHeaders[key];
            var header = "[" + key + " \"" + value + "\"]";
            headers.push(header);
        }
        if (headers.length <= 0)
            return "";
        return headers.join("\n") + "\n\n";
    };
    Board.prototype.reportPgnStrStandard = function () {
        var pgnstr = "";
        var sanlist = [];
        var cn = this.root;
        while (cn.haschild()) {
            var ch = cn.mainchild();
            var mn = "";
            if (cn.turn == 1)
                mn = cn.fullmove_number + ". ";
            sanlist.push(mn + ch.gensan);
            cn = ch;
        }
        pgnstr = sanlist.join(" ");
        var hsstr = this.reportPgnHeadersStr();
        return hsstr + pgnstr;
    };
    Board.prototype.reportPgnStr = function () {
        if (this.cfg.standardReportable)
            return this.reportPgnStrStandard();
        return JSON.stringify(this.reportPgn());
    };
    Board.prototype.setFromPgn = function (pgn) {
        var t = new GlobalUtils.Timer("set from PGN", this.log.bind(this));
        this.variant = pgn.variant;
        this.Construct();
        if (pgn.headers != undefined)
            this.pgnHeaders = pgn.headers;
        this.setFromTreeNode(pgn.tree);
        t.report();
        this.log("number of nodes " + this.allnodes);
        this.draw();
    };
    Board.prototype.setFromPgnStrStandard = function (pgnstr) {
        var _this = this;
        pgnstr = pgnstr.replace(new RegExp("\\r", "g"), "");
        var lines = pgnstr.split("\n");
        this.pgnHeaders = {};
        var movelistbuffer = [];
        var moveliststarted = false;
        for (var li in lines) {
            var line = lines[li];
            var t_1 = new Utils.Tokenizer(line);
            if (!moveliststarted) {
                var c = t_1.pull(["["]);
                if (c != "") {
                    var key = t_1.pull(null);
                    t_1.pull([" ", "\""]);
                    var value = t_1.pullUntil("\"");
                    this.pgnHeaders[key] = value;
                }
                else {
                    var token = t_1.pull(null);
                    if (token != "") {
                        moveliststarted = true;
                        movelistbuffer.push(line);
                    }
                }
            }
            else {
                movelistbuffer.push(line);
            }
        }
        var movelist = movelistbuffer.join(" ");
        var sanlist = [];
        var t = new Utils.Tokenizer(movelist);
        var san;
        do {
            san = t.pullSan();
            if (san != "") {
                sanlist.push(san);
            }
        } while (san != "");
        this.reset();
        sanlist.map(function (san) {
            var m = _this.sanToMove(san);
            var rm = _this.toRichMove(m);
            _this.makeMove(rm);
        });
        this.log("number of sans " + sanlist.length);
        this.draw();
    };
    Board.prototype.setFromPgnStr = function (pgnstr) {
        if (this.cfg.standardReportable) {
            this.setFromPgnStrStandard(pgnstr);
            return;
        }
        var pgn = JSON.parse(pgnstr);
        this.setFromPgn(pgn);
    };
    Board.prototype.log = function (item) {
        var _this = this;
        this.mainlog.log(item);
        if (this.tabs != undefined) {
            var loghtml_1 = this.reportLogHtml();
            setTimeout(function (Event) {
                _this.tabs.setContent("log", loghtml_1);
            }, 50);
        }
    };
    Board.prototype.reportLogHtml = function () {
        return this.mainlog.logitems.slice().reverse().map(function (x) { return x + "<br>"; }).join("\n");
    };
    Board.prototype.correctPromLetter = function (kind) {
        if (!this.cfg.standardReportable)
            return kind;
        if (this.state.turn == 0)
            return kind;
        return kind.toUpperCase();
    };
    Board.prototype.moveToSan = function (m) {
        var _a = this.moveToSanNotCastlingCorrected(m), san = _a[0], rm = _a[1];
        if ((!this.cfg.standardReportable) || (!rm.castling))
            return san;
        var csm = Config.STANDARD_CASTLE_SAN_MAPPINGS[this.state.turn];
        var csan = csm.g(san);
        return csan;
    };
    Board.prototype.moveToSanNotCastlingCorrected = function (m) {
        var rm = this.toRichMove(m);
        if (rm == null)
            return null;
        var fromsqalgeb = this.squareToAlgeb(rm.fromsq);
        var tosqalgeb = this.squareToAlgeb(rm.tosq);
        var algeb = this.moveToAlgeb(m);
        if (rm.pawnmove) {
            var prom = (m.promotion ? "=" + this.correctPromLetter(m.prom.kind) : "");
            if (rm.capture) {
                var efsa = fromsqalgeb;
                if (this.cfg.standardReportable)
                    efsa = fromsqalgeb[0];
                return [efsa + "x" + tosqalgeb + prom, rm];
            }
            else {
                return [tosqalgeb + prom, rm];
            }
        }
        var fromsq = m.fromsq;
        var tosq = m.tosq;
        var p = this.getPieceAtSquare(fromsq);
        var lms = this.legalMoves([new Piece(p.kind, 100), new Move(tosq, null)]);
        var efs = 0;
        var ers = 0;
        var es = 0;
        for (var lmi in lms) {
            var lm = lms[lmi];
            var tfromsq = lm.tosq;
            var tfp = this.getPieceAtSquare(tfromsq);
            if (tfp.equalto(p)) {
                if (!tfromsq.isEqualTo(fromsq)) {
                    es++;
                    if (tfromsq.file == fromsq.file)
                        efs++;
                    if (tfromsq.rank == fromsq.rank)
                        ers++;
                }
            }
        }
        var P = p.kind.toUpperCase();
        var cl = rm.capture ? "x" : "";
        if (es == 0)
            return [P + cl + tosqalgeb, rm];
        if ((efs > 0) && (ers > 0))
            return [P + fromsqalgeb + cl + tosqalgeb, rm];
        if (efs > 0)
            return [P + fromsqalgeb.substring(1) + cl + tosqalgeb, rm];
        return [P + fromsqalgeb.substring(0, 1) + cl + tosqalgeb, rm];
    };
    Board.prototype.sanToRichMove = function (san) {
        var m = this.sanToMove(san);
        if (m == null)
            return null;
        return this.toRichMove(m);
    };
    Board.prototype.makeSanMove = function (san) {
        var rm = this.sanToRichMove(san);
        if (rm != null) {
            this.makeMove(rm);
        }
    };
    Board.prototype.sanToMove = function (san) {
        var parts = san.split("=");
        var sannonprom = parts[0];
        var pp = new Piece();
        if (parts.length > 1) {
            var pkind = parts[1][0].toLowerCase();
            pp = new Piece(pkind, this.state.turn);
        }
        var m = this.sanToMoveNonPromotion(sannonprom, pp);
        if (m == null)
            return null;
        if (parts.length <= 1)
            return m;
        m.prom = pp;
        return m;
    };
    Board.prototype.sanToMoveNonPromotion = function (san, prompiece) {
        if (this.cfg.standardReportable) {
            var csm = Config.STANDARD_CASTLE_SAN_MAPPINGS[this.state.turn];
            var csan = csm.g(san);
            if (csan != null)
                san = csan;
        }
        var sannox = san.replace("x", "");
        var t = new Utils.Tokenizer(sannox);
        var cap = t.pull(this.cfg.nonPawnPiecesCapital, 1);
        var sq1 = t.pullSquare(this);
        var sq2 = t.pullSquare(this);
        var fromsq = sq1;
        var tosq = sq2;
        if (sq1 == null)
            return null;
        if (sq2 == null) {
            fromsq = new Square(null, null);
            tosq = sq1;
        }
        if (cap != "") {
            var kind = cap.toLowerCase();
            var rp = new Piece(kind, this.state.turn);
            if (kind == "k") {
                var wk = this.whereIsKing();
                if (wk != null) {
                    var klms = this.legalMoves([rp, new Move(wk, null)]);
                    for (var klmsi in klms) {
                        var klm = klms[klmsi];
                        if (klm.tosq.isEqualTo(tosq))
                            return klm;
                    }
                }
            }
            var lms = this.pseudoLegalMovesForPieceAtSquare(new Piece(kind, 100), tosq)[0];
            for (var lmi in lms) {
                var lm = lms[lmi];
                var p = this.getPieceAtSquare(lm.tosq);
                if (p.equalto(rp)) {
                    if (lm.tosq.isRoughlyEqualTo(fromsq))
                        return new Move(lm.tosq, tosq);
                }
            }
        }
        else {
            var pdir = this.cfg.pawnDirectionsByColor[this.state.turn];
            var testsqs = [];
            var bsq = tosq.Minus(pdir);
            testsqs.push(bsq);
            testsqs.push(bsq.Plus(pdir.Rotate(1)));
            testsqs.push(bsq.Plus(pdir.Rotate(-1)));
            if (this.isSquareValid(bsq)) {
                if (this.getPieceAtSquare(bsq).empty()) {
                    var bsq2 = bsq.Minus(pdir);
                    var bsq2test = bsq2.Minus(pdir).Minus(pdir);
                    if (!this.isSquareValid(bsq2test))
                        testsqs.push(bsq2);
                }
            }
            var testp = new Piece("p", this.state.turn);
            for (var ti in testsqs) {
                var tsq = testsqs[ti];
                if (this.isSquareValid(tsq)) {
                    if (this.getPieceAtSquare(tsq).equalto(testp)) {
                        if (tsq.isRoughlyEqualTo(fromsq)) {
                            var trymove = new Move(tsq, tosq, prompiece);
                            if (this.isMoveLegal(trymove))
                                return trymove;
                        }
                    }
                }
            }
        }
        return null;
    };
    Board.prototype.pgnStoreKey = function () {
        return "pgn_" + this.variant;
    };
    Board.prototype.constructFromVariant = function (variant) {
        this.Variant(variant).Construct();
        var pgnstr = localStorage.getItem(this.pgnStoreKey());
        if (pgnstr != undefined) {
            this.setFromPgnStr(pgnstr);
        }
        else {
            this.draw();
        }
    };
    Board.prototype.setDefaultPgnHeaders = function () {
        this.pgnHeaders = {
            "Variant": BoardDraw.variantDisplayName(this.variant),
            "FEN": this.startfen
        };
    };
    Board.prototype.drawMoveArrow = function (m, div, params) {
        if (div === void 0) { div = null; }
        if (params === void 0) { params = {}; }
        var fromsq = this.rotateSquare(m.fromsq, this.flip);
        var tosq = this.rotateSquare(m.tosq, this.flip);
        var fromv = new GlobalUtils.Vect(fromsq.file + 0.5, fromsq.rank + 0.5).s(this.SQUARE_SIZE * Config.scalefactor);
        var tov = new GlobalUtils.Vect(tosq.file + 0.5, tosq.rank + 0.5).s(this.SQUARE_SIZE * Config.scalefactor);
        if (params["scale"] == undefined) {
            params["scale"] = 1.0;
        }
        if (params["constantwidth"] == undefined) {
            params["constantwidth"] = this.SQUARE_SIZE / 7.5 * Config.scalefactor * params["scale"];
        }
        var arrow = new GlobalUtils.Arrow(fromv, tov, params);
        var adiv = (div == null ? new Div_() : div);
        adiv.
            spos("absolute").
            stpx(arrow.svgorig.y).
            slpx(arrow.svgorig.x).
            szi(Board.ARROW_Z_INDEX).
            html(arrow.svg);
        this.rootnode.a(adiv);
    };
    Board.prototype.drawMoveArrowAlgeb = function (algeb, div, params) {
        if (div === void 0) { div = null; }
        if (params === void 0) { params = {}; }
        var m = this.algebToMove(algeb);
        this.drawMoveArrow(m, div, params);
    };
    Board.prototype.logws = function (msg, connectid, details) {
        if (details === void 0) { details = ""; }
        this.log("[ " + connectid + " ] " + msg + (details != "" ? " : " : "") + details);
    };
    Board.prototype.sendem = function (em, connectid) {
        var json = JSON.stringify(em);
        this.logws("sending message", connectid, json);
        /////////////////////////////////////////////
        this.ws.send(json);
        /////////////////////////////////////////////        
    };
    Board.prototype.startengine = function (name) {
        if (name === void 0) { name = this.defaultengine; }
        if (this.defaultengine == undefined) {
            this.log("no engine available");
            return;
        }
        var em = new EngineMessage().
            _action("start").
            _name(name);
        this.connect(em);
    };
    Board.prototype.getenginecolor = function () {
        return (this.thinkingoutput.score > 0 ? Board.POS_EVAL_MOVE_COL : Board.NEG_EVAL_MOVE_COL);
    };
    Board.prototype.displayenginescore = function () {
        var ecol = this.getenginecolor();
        this.depthdiv.
            spos("absolute").
            stpx(this.width() / 5.0).
            slpx(this.width() / 5.0).
            szi(Board.ARROW_Z_INDEX + 1).
            sfsspx(this.SQUARE_SIZE).
            scol(Board.ENGINE_DEPTH_COL).
            html("" + this.thinkingoutput.depth);
        this.scorediv.
            spos("absolute").
            stpx(this.width() / 3.0).
            slpx(this.width() / 3.0).
            szi(Board.ARROW_Z_INDEX + 1).
            sfsspx(this.SQUARE_SIZE * 2.0).
            scol(ecol).
            html("" + this.thinkingoutput.score);
    };
    Board.prototype.onmessage = function (connectid, e) {
        //this.logws("connection sent",connectid,e.data)
        var em = new EngineMessage().parseJson(e.data);
        if (em.action == "available") {
            this.logws("available", connectid, em.available.toString());
            this.defaultengine = em.available[0];
            this.startengine();
        }
        if (em.action == "thinkingoutput") {
            this.tolog.log(em.buffer);
            var content = this.tolog.logitems.slice().reverse().join("\n");
            this.fentext.setText(content);
            if (this.enginerunning) {
                var to = this.thinkingoutput;
                to.parse(em.buffer);
                var algeb = this.thinkingoutput.bestmove;
                if (algeb != "") {
                    var m = this.algebToMove(algeb);
                    if (this.isMoveLegal(m)) {
                        var color = this.getenginecolor();
                        var params = { "color": color, "scale": 1.5 };
                        this.drawMoveArrowAlgeb(algeb, this.enginearrow, params);
                        this.displayenginescore();
                    }
                }
            }
        }
    };
    Board.prototype.wsopen = function (connectid, em, e) {
        if (em === void 0) { em = null; }
        this.logws("connection opened", connectid);
        if (em != null)
            this.sendem(em, connectid);
    };
    Board.prototype.connect = function (em) {
        if (em === void 0) { em = new EngineMessage()._action("sendavailable"); }
        this.tabs.setSelected("log");
        this.connectid++;
        this.logws("connecting to server...", this.connectid);
        this.ws = new WebSocket("ws://localhost:9000/ws");
        this.ws.onopen = this.wsopen.bind(this, this.connectid, em);
        this.ws.onmessage = this.onmessage.bind(this, this.connectid);
    };
    Board.prototype.analyze = function () {
        if (this.defaultengine == undefined) {
            this.log("no engine available");
            return;
        }
        this.thinkingoutput = new Utils.ThinkingOutput();
        this.stopanalysis();
        var fen = this.reportFen();
        var em = new EngineMessage().
            _action("issue").
            _command("position fen " + fen + "\ngo infinite\n");
        this.sendem(em, this.connectid);
        this.enginerunning = true;
    };
    Board.prototype.stopanalysis = function () {
        this.enginerunning = false;
        if (this.defaultengine == undefined) {
            this.log("no engine available");
            return;
        }
        var em = new EngineMessage().
            _action("issue").
            _command("stop");
        this.sendem(em, this.connectid);
    };
    Board.prototype.makeanalyzedmove = function () {
        if (this.defaultengine == undefined) {
            this.log("no engine available");
            return;
        }
        if (this.thinkingoutput == undefined) {
            this.log("no thinking output");
            return;
        }
        var algeb = this.thinkingoutput.bestmove;
        if (algeb != "") {
            var m = this.algebToMove(algeb);
            var rm = this.toRichMove(m);
            if (rm != null) {
                this.makeMove(rm);
                this.draw();
            }
        }
    };
    /////////////////////////////////////////////////////////////////////////
    Board.DEFAULT_VARIANT = "standard";
    Board.DEFAULT_BOARD_SIZE = 400.0;
    Board.PIECE_OPACITIES = [1.0, 1.0, 1.0, 1.0];
    Board.PIECE_FILL_COLORS = ["#000000", "#ffffff", "#ffff00", "#ff0000"];
    Board.PIECE_STROKE_COLORS = ["#ffffff", "#dfdfdf", "#afafaf", "#afafaf"];
    Board.SQUARE_OPACITY = 0.2;
    Board.DARK_SQUARE_COLOR = "#8f8f8f";
    Board.LIGHT_SQUARE_COLOR = "#dfdfdf";
    Board.CONTAINER_Z_INDEX = 10;
    Board.BACKGROUND_Z_INDEX = 50;
    Board.SQUARE_Z_INDEX = 100;
    Board.ARROW_Z_INDEX = 150;
    Board.PIECE_Z_INDEX = 200;
    Board.DRAGGED_PIECE_Z_INDEX = 500;
    Board.POS_EVAL_MOVE_COL = "#00ff00";
    Board.NEG_EVAL_MOVE_COL = "#ff0000";
    Board.ENGINE_DEPTH_COL = "#0000ff";
    return Board;
}());
//localStorage.clear()
new Board().AnchorId("root").Main().wConstruct(function (b) {
    var cv = localStorage.getItem("currentvariant");
    if (cv != undefined)
        b.constructFromVariant(cv);
    else
        b.draw();
    //BoardDraw.randomhandler.bind(b)(null)
});
